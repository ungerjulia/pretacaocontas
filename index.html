<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IB ¬∑ Presta√ß√£o de Contas</title>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIV9U__iJPHPjrVHupdVpadE4Pei1zAOA",
    authDomain: "independent-brazil.firebaseapp.com",
    projectId: "independent-brazil",
    storageBucket: "independent-brazil.firebasestorage.app",
    messagingSenderId: "3294487230",
    appId: "1:3294487230:web:fedc93f7a1b4b66dbc34ef"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._db = db;
  window._fbModules = { collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy };

  async function ensureDefaults() {
    try {
      const { doc, getDoc, setDoc } = window._fbModules;
      // Admin user
      const adminRef = doc(db, 'users', 'u0');
      const adminSnap = await getDoc(adminRef);
      if (!adminSnap.exists()) {
        await setDoc(adminRef, { id:'u0', name:'Admin Financeiro', email:'financial@independentbrazil.com', password:'admin123', role:'admin', createdAt: new Date().toISOString() });
      }
      // Default categories
      const catRef = doc(db, 'config', 'categories');
      const catSnap = await getDoc(catRef);
      if (!catSnap.exists()) {
        await setDoc(catRef, { list: ['Viagem','Aluguel de Carro','Alimenta√ß√£o','Brinde','Outros'] });
      }
      window._firebaseReady = true;
      document.dispatchEvent(new Event('firebaseReady'));
    } catch(e) {
      console.error(e);
      window._firebaseReady = true;
      document.dispatchEvent(new Event('firebaseReady'));
    }
  }
  ensureDefaults();
</script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  window.addEventListener('load', () => {
    emailjs.init({ publicKey: '9A4MxQWrnZ3cwvxAg' });
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --black:#0a0a0a; --white:#f5f5f0; --gray:#1a1a1a; --gray2:#2a2a2a;
    --accent:#c8a84b; --accent2:#e8c96b; --text-dim:#888;
    --danger:#e05555; --success:#4caf7d; --border:rgba(255,255,255,0.08);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--black);color:var(--white);min-height:100vh;overflow-x:hidden;}

  #loader{position:fixed;inset:0;background:var(--black);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
  .loader-logo{font-family:'Bebas Neue',sans-serif;font-size:80px;color:var(--white);letter-spacing:10px;animation:pulse 1.5s infinite;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
  .loader-text{font-size:12px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-top:16px;}

  #loginScreen{min-height:100vh;display:none;align-items:center;justify-content:center;background:var(--black);position:relative;overflow:hidden;}
  #loginScreen::before{content:'IB';position:absolute;font-family:'Bebas Neue',sans-serif;font-size:clamp(200px,40vw,500px);color:rgba(255,255,255,0.03);letter-spacing:-10px;user-select:none;pointer-events:none;}
  .login-box{background:var(--gray);border:1px solid var(--border);padding:48px 40px;width:100%;max-width:420px;position:relative;z-index:1;}
  .login-logo{display:flex;align-items:center;gap:14px;margin-bottom:36px;}
  .logo-mark{width:52px;height:52px;background:var(--white);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .logo-mark span{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--black);letter-spacing:1px;}
  .login-logo-text{display:flex;flex-direction:column;}
  .login-logo-text strong{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--white);}
  .login-logo-text small{font-size:11px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
  .login-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:6px;}
  .login-sub{font-size:13px;color:var(--text-dim);margin-bottom:32px;}

  .field{margin-bottom:18px;}
  .field label{display:block;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;}
  .field input,.field select,.field textarea{width:100%;background:var(--black);border:1px solid var(--border);color:var(--white);padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
  .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);}
  .field select option{background:var(--black);}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:13px 22px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border:none;transition:all .2s;}
  .btn-primary{background:var(--white);color:var(--black);}
  .btn-primary:hover{background:var(--accent2);}
  .btn-gold{background:var(--accent);color:var(--black);}
  .btn-gold:hover{background:var(--accent2);}
  .btn-outline{background:transparent;border:1px solid var(--border);color:var(--white);}
  .btn-outline:hover{border-color:var(--accent);color:var(--accent);}
  .btn-danger-solid{background:var(--danger);color:#fff;}
  .btn-full{width:100%;justify-content:center;}
  .error-msg{color:var(--danger);font-size:12px;margin-top:10px;}

  #app{display:none;min-height:100vh;flex-direction:column;}
  header{background:var(--gray);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
  .header-left{display:flex;align-items:center;gap:14px;}
  .header-logo{width:36px;height:36px;background:var(--white);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .header-logo span{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--black);}
  .header-brand{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;color:var(--white);}
  .header-role{font-size:11px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;}
  .header-right{display:flex;align-items:center;gap:12px;}
  .user-pill{display:flex;align-items:center;gap:8px;background:var(--black);border:1px solid var(--border);padding:6px 12px;font-size:12px;color:var(--text-dim);}
  .user-pill strong{color:var(--white);font-size:13px;}
  main{flex:1;padding:32px 24px;max-width:1200px;width:100%;margin:0 auto;}

  .page-header{margin-bottom:32px;}
  .page-title{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;}
  .page-sub{font-size:13px;color:var(--text-dim);margin-top:4px;}
  .card{background:var(--gray);border:1px solid var(--border);padding:32px;margin-bottom:24px;}
  .card-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
  .card-title .dot{width:6px;height:6px;background:var(--accent);flex-shrink:0;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  @media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
  .form-grid .full{grid-column:1/-1;}

  /* Multiple expense lines */
  .expense-line{background:var(--black);border:1px solid var(--border);padding:16px;margin-bottom:12px;position:relative;}
  .expense-line-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .expense-line-num{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:var(--accent);}
  .remove-line-btn{background:none;border:none;color:var(--danger);cursor:pointer;font-size:18px;padding:2px 6px;}

  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;}
  .stat-card{background:var(--gray);border:1px solid var(--border);padding:20px 24px;}
  .stat-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;}
  .stat-value{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--accent2);letter-spacing:1px;}
  .stat-sub{font-size:11px;color:var(--text-dim);margin-top:4px;}

  .expense-list{display:flex;flex-direction:column;gap:12px;}
  .expense-item{background:var(--black);border:1px solid var(--border);padding:16px 20px;display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:16px;transition:border-color .2s;cursor:pointer;}
  .expense-item:hover{border-color:rgba(200,168,75,0.4);}
  .cat-badge{padding:4px 10px;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;background:var(--gray2);color:var(--accent);white-space:nowrap;}
  .exp-info strong{font-size:14px;font-weight:500;display:block;}
  .exp-info small{font-size:12px;color:var(--text-dim);}
  .exp-amount{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:var(--accent2);white-space:nowrap;}
  .exp-date{font-size:11px;color:var(--text-dim);text-align:right;white-space:nowrap;}
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;font-size:10px;letter-spacing:1px;text-transform:uppercase;}
  .status-pending{background:rgba(200,168,75,0.15);color:var(--accent);}
  .status-approved{background:rgba(76,175,125,0.15);color:var(--success);}
  .status-rejected{background:rgba(224,85,85,0.15);color:var(--danger);}

  .tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:32px;}
  .tab{padding:12px 24px;font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .2s;background:none;border-left:none;border-right:none;border-top:none;}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent);}
  .tab:hover:not(.active){color:var(--white);}

  .filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px;align-items:center;}
  .filters input,.filters select{background:var(--gray);border:1px solid var(--border);color:var(--white);padding:9px 14px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
  .filters input:focus,.filters select:focus{border-color:var(--accent);}
  .filters select option{background:var(--black);}

  .admin-table-wrap{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;}
  th{text-align:left;padding:10px 14px;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);border-bottom:1px solid var(--border);white-space:nowrap;}
  td{padding:12px 14px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
  tr.clickable:hover td{background:rgba(200,168,75,0.05);cursor:pointer;}
  .trader-avatar{width:30px;height:30px;background:var(--accent);color:var(--black);display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;vertical-align:middle;flex-shrink:0;}

  .biz-section{margin-bottom:28px;}
  .biz-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px;}
  .biz-section-title{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:3px;color:var(--text-dim);}
  .biz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px;}
  .biz-card{background:var(--black);border:1px solid var(--border);padding:18px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
  .biz-bar{width:4px;height:36px;flex-shrink:0;}
  .biz-name{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;}
  .biz-count{font-size:10px;color:var(--text-dim);}
  .biz-amounts{display:flex;gap:20px;flex-wrap:wrap;}
  .biz-amount-label{font-size:10px;color:var(--text-dim);letter-spacing:1px;margin-bottom:2px;}
  .biz-amount-val{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--white);}

  .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
  .user-card{background:var(--black);border:1px solid var(--border);padding:20px;display:flex;align-items:center;gap:14px;}
  .user-avatar-lg{width:44px;height:44px;background:var(--accent);color:var(--black);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0;}
  .user-info strong{font-size:14px;display:block;}
  .user-info small{font-size:12px;color:var(--text-dim);display:block;}
  .user-biz{font-size:11px;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}

  .cat-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
  .cat-tag{display:flex;align-items:center;gap:6px;background:var(--gray2);border:1px solid var(--border);padding:6px 12px;font-size:12px;}
  .cat-tag button{background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;line-height:1;padding:0;}

  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:999;align-items:center;justify-content:center;padding:16px;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--gray);border:1px solid var(--border);padding:36px;width:100%;max-width:560px;animation:slideUp .25s ease;max-height:90vh;overflow-y:auto;}
  .modal-wide{max-width:720px;}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;margin-bottom:24px;}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;flex-wrap:wrap;}

  .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .detail-item label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:4px;}
  .detail-item span{font-size:14px;}
  .detail-item.full{grid-column:1/-1;}
  .detail-divider{grid-column:1/-1;height:1px;background:var(--border);margin:8px 0;}

  .upload-area{border:2px dashed var(--border);padding:28px 16px;text-align:center;cursor:pointer;transition:border-color .2s;position:relative;background:var(--black);}
  .upload-area:hover{border-color:var(--accent);}
  .upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;}
  .upload-label{font-size:13px;color:var(--text-dim);}
  .upload-label span{color:var(--accent);font-weight:600;}
  .upload-label small{display:block;margin-top:4px;font-size:11px;}
  .preview-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;}
  .preview-wrap{position:relative;}
  .preview-thumb{width:80px;height:80px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:border-color .2s;display:block;}
  .preview-thumb:hover{border-color:var(--accent);}
  .preview-remove{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;}

  .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center;}
  .lightbox.open{display:flex;}
  .lightbox img{max-width:90vw;max-height:88vh;object-fit:contain;}
  .lightbox-close{position:fixed;top:16px;right:20px;font-size:28px;color:#fff;cursor:pointer;background:none;border:none;line-height:1;}

  .action-btn{padding:5px 10px;font-size:10px;letter-spacing:1px;text-transform:uppercase;font-weight:600;cursor:pointer;border:1px solid;background:transparent;transition:all .2s;font-family:'DM Sans',sans-serif;}
  .action-approve{border-color:var(--success);color:var(--success);}
  .action-approve:hover{background:var(--success);color:var(--black);}
  .action-reject{border-color:var(--danger);color:var(--danger);}
  .action-reject:hover{background:var(--danger);color:var(--white);}
  .action-delete{border-color:#666;color:#666;}
  .action-delete:hover{background:#666;color:var(--white);}

  .toast{position:fixed;bottom:24px;right:24px;background:var(--gray);border-left:3px solid var(--success);padding:14px 20px;font-size:13px;z-index:9999;animation:slideUp .3s ease;max-width:320px;display:none;}
  .toast.error{border-left-color:var(--danger);}

  .empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);}
  .empty-state .big{font-family:'Bebas Neue',sans-serif;font-size:48px;color:rgba(255,255,255,0.05);}
  .empty-state p{font-size:14px;margin-top:8px;}

  .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}



  /* FULL LIST PAGE */
  #fullListPage {
    display:none; position:fixed; inset:0;
    background:var(--black); z-index:498;
    overflow-y:auto; animation:fadeIn .2s ease;
  }
  .full-list-header {
    background:var(--gray); border-bottom:1px solid var(--border);
    padding:0 24px; height:60px;
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:10;
  }
  .full-list-content { max-width:1300px; margin:0 auto; padding:28px 24px; }

  /* DETAIL PAGE */
  #detailPage {
    display:none; position:fixed; inset:0;
    background:var(--black); z-index:500;
    overflow-y:auto; animation:fadeIn .2s ease;
  }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .detail-page-header {
    background:var(--gray); border-bottom:1px solid var(--border);
    padding:0 24px; height:60px;
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:10;
  }
  .detail-page-back {
    display:flex; align-items:center; gap:10px;
    cursor:pointer; color:var(--accent);
    font-size:13px; font-weight:600; letter-spacing:1px;
    text-transform:uppercase; background:none; border:none;
  }
  .detail-page-back:hover { color:var(--accent2); }
  .detail-page-back svg { width:18px; height:18px; }
  .detail-page-content { max-width:900px; margin:0 auto; padding:32px 24px; }
  .detail-page-title { font-family:'Bebas Neue',sans-serif; font-size:32px; letter-spacing:2px; margin-bottom:4px; }
  .detail-page-sub { font-size:13px; color:var(--text-dim); margin-bottom:28px; }
  .detail-section { background:var(--gray); border:1px solid var(--border); padding:24px; margin-bottom:20px; }
  .detail-section-title { font-family:'Bebas Neue',sans-serif; font-size:14px; letter-spacing:3px; color:var(--text-dim); margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid var(--border); }
  .detail-meta-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:16px; }
  .detail-meta-item label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); display:block; margin-bottom:4px; }
  .detail-meta-item span { font-size:14px; font-weight:500; }
  .detail-line { background:var(--black); border:1px solid var(--border); padding:14px 18px; margin-bottom:8px; display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
  .detail-line-num { font-family:'Bebas Neue',sans-serif; font-size:12px; letter-spacing:2px; color:var(--text-dim); min-width:50px; }
  .detail-line-amount { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--accent2); }
  .detail-line-desc { font-size:12px; color:var(--text-dim); flex:1; }
  .detail-images { display:flex; flex-wrap:wrap; gap:10px; }
  .detail-img { width:100px; height:100px; object-fit:cover; border:1px solid var(--border); cursor:pointer; transition:all .2s; }
  .detail-img:hover { border-color:var(--accent); transform:scale(1.03); }
  .detail-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:24px; }
  @media(max-width:600px) {
    .detail-page-content { padding:20px 14px; }
    .detail-line { flex-direction:column; align-items:flex-start; gap:8px; }
  }

  @media(max-width:700px){
    main{padding:20px 14px;}
    .card{padding:20px;}
    .expense-item{grid-template-columns:1fr 1fr;}
    .header-brand{display:none;}
    .stats-row{grid-template-columns:1fr 1fr;}
    .detail-grid{grid-template-columns:1fr;}
  }
</style>
</head>
<body>

<div id="loader">
  <div class="loader-logo">IB</div>
  <div class="loader-text">Conectando ao sistema...</div>
</div>

<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-mark"><span>IB</span></div>
      <div class="login-logo-text">
        <strong>INDEPENDENT BRAZIL</strong>
        <small>Com√©rcio Exterior</small>
      </div>
    </div>
    <div class="login-title">Acesso ao Sistema</div>
    <p class="login-sub">Presta√ß√£o de Contas ¬∑ Traders & Financeiro</p>
    <div class="field">
      <label>E-mail</label>
      <input type="email" id="loginUser" placeholder="seu@email.com" autocomplete="username">
    </div>
    <div class="field">
      <label>Senha</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <div id="loginError" class="error-msg"></div>
    <div style="margin-top:24px;">
      <button class="btn btn-primary btn-full" id="loginBtn" onclick="doLogin()">Entrar</button>
    </div>
  </div>
</div>

<div id="app">
  <header>
    <div class="header-left">
      <div class="header-logo"><span>IB</span></div>
      <div>
        <div class="header-brand">INDEPENDENT BRAZIL</div>
        <div class="header-role" id="headerRole"></div>
      </div>
    </div>
    <div class="header-right">
      <div class="user-pill"><strong id="headerUser"></strong></div>
      <button class="btn btn-outline" style="padding:8px 14px;font-size:11px;" onclick="logout()">Sair</button>
    </div>
  </header>
  <main id="mainContent"></main>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="modalTitle"></div>
    <div id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<div class="lightbox" id="lightbox">
  <button class="lightbox-close" onclick="document.getElementById('lightbox').classList.remove('open')">&#x2715;</button>
  <img id="lightboxImg" src="" alt="">
</div>

<div class="toast" id="toastEl"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BIZ_LINES = ['Import','Feed Meal','Meat','Commodities','Seafood','Gerencia','Financeiro','Operacional','Analista Comercial'];
const BIZ_COLORS = {
  'Import':'#4a9eff','Feed Meal':'#c8a84b','Meat':'#e05555',
  'Commodities':'#4caf7d','Seafood':'#a78bfa',
  'Gerencia':'#f97316','Financeiro':'#06b6d4',
  'Operacional':'#84cc16','Analista Comercial':'#ec4899'
};
const CURR_SYMBOL = { BRL:'R$', USD:'US$', EUR:'‚Ç¨' };
const STATUS_LABEL = { pending:'Pendente', approved:'Aprovado', rejected:'Recusado' };
const STATUS_CLASS = { pending:'status-pending', approved:'status-approved', rejected:'status-rejected' };

let state = { currentUser: null };
let pendingImages = [];
let allExpenses = [];
let adminTab = 'expenses';
let expenseLines = [{ id: Date.now() }];
let globalCategories = ['Viagem','Aluguel de Carro','Alimenta√ß√£o','Brinde','Outros'];
let filteredExpenses = [];

// Session persistence
function saveSession(user) { try { sessionStorage.setItem('ib_session', JSON.stringify(user)); } catch(e){} }
function loadSession() { try { const s = sessionStorage.getItem('ib_session'); return s ? JSON.parse(s) : null; } catch(e){ return null; } }
function clearSession() { try { sessionStorage.removeItem('ib_session'); } catch(e){} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function db() { return window._db; }
function fb() { return window._fbModules; }

async function fbGetAll(collName) {
  const { collection, getDocs, query, orderBy } = fb();
  const q = query(collection(db(), collName), orderBy('createdAt','desc'));
  const snap = await getDocs(q);
  return snap.docs.map(d => d.data());
}
async function fbGet(collName, id) {
  const { doc, getDoc } = fb();
  const snap = await getDoc(doc(db(), collName, id));
  return snap.exists() ? snap.data() : null;
}
async function fbSet(collName, id, data) {
  const { doc, setDoc } = fb();
  await setDoc(doc(db(), collName, id), data);
}
async function fbUpdate(collName, id, data) {
  const { doc, updateDoc } = fb();
  await updateDoc(doc(db(), collName, id), data);
}
async function fbDelete(collName, id) {
  const { doc, deleteDoc } = fb();
  await deleteDoc(doc(db(), collName, id));
}
async function loadCategories() {
  const cfg = await fbGet('config', 'categories');
  if (cfg && cfg.list) globalCategories = cfg.list;
}
async function saveCategories() {
  await fbSet('config', 'categories', { list: globalCategories });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('firebaseReady', async () => {
  await loadCategories();
  const session = loadSession();
  if (session) {
    // Re-validate session user still exists
    try {
      const users = await fbGetAll('users');
      const user = users.find(u => u.id === session.id);
      if (user) {
        state.currentUser = user;
        document.getElementById('loader').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('headerUser').textContent = user.name;
        document.getElementById('headerRole').textContent = user.role === 'admin' ? 'Financeiro ¬∑ Admin' : `Trader ¬∑ ${user.businessLine||''}`;
        if (user.role === 'admin') renderAdmin();
        else renderTrader();
        return;
      }
    } catch(e) {}
  }
  document.getElementById('loader').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
});
setTimeout(() => {
  if (!window._firebaseReady) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
  }
}, 6000);
document.addEventListener('keydown', e => { if(e.key==='Enter' && document.getElementById('loginScreen').style.display!=='none') doLogin(); });
document.getElementById('lightbox').addEventListener('click', e => { if(e.target===e.currentTarget) e.currentTarget.classList.remove('open'); });
document.getElementById('modalOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin() {
  const email = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const btn = document.getElementById('loginBtn');
  btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
  try {
    const users = await fbGetAll('users');
    const user = users.find(u => u.email === email && u.password === pass);
    if (!user) {
      document.getElementById('loginError').textContent = 'E-mail ou senha incorretos.';
      btn.innerHTML = 'Entrar'; btn.disabled = false; return;
    }
    state.currentUser = user;
    saveSession(user);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('headerUser').textContent = user.name;
    document.getElementById('headerRole').textContent = user.role === 'admin' ? 'Financeiro ¬∑ Admin' : `Trader ¬∑ ${user.businessLine||''}`;
    if (user.role === 'admin') renderAdmin();
    else renderTrader();
  } catch(e) {
    document.getElementById('loginError').textContent = 'Erro de conex√£o. Tente novamente.';
  }
  btn.innerHTML = 'Entrar'; btn.disabled = false;
}

function logout() {
  state.currentUser = null;
  pendingImages = [];
  expenseLines = [{ id: Date.now() }];
  clearSession();
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginError').textContent = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADER VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTrader() {
  document.getElementById('mainContent').innerHTML = '<div style="text-align:center;padding:60px;"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>';
  try {
    const all = await fbGetAll('expenses');
    const mine = all.filter(e => e.userId === state.currentUser.id);
    renderTraderHTML(mine);
  } catch(e) { toast('Erro ao carregar dados.', true); }
}

function renderTraderHTML(mine) {
  expenseLines = [{ id: Date.now() }];
  const html = `
    <div class="page-header">
      <div class="page-title">Ol√°, ${state.currentUser.name.split(' ')[0]}</div>
      <div class="page-sub">Gerencie suas presta√ß√µes de contas ¬∑ ${state.currentUser.businessLine||''}</div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total enviado</div><div class="stat-value">${mine.length}</div><div class="stat-sub">presta√ß√µes</div></div>
      <div class="stat-card"><div class="stat-label">Pendentes</div><div class="stat-value">${mine.filter(e=>e.status==='pending').length}</div><div class="stat-sub">aguardando aprova√ß√£o</div></div>
      <div class="stat-card"><div class="stat-label">Aprovadas</div><div class="stat-value">${mine.filter(e=>e.status==='approved').length}</div><div class="stat-sub">reembolsos</div></div>
    </div>
    <div class="card">
      <div class="card-title"><div class="dot"></div> Nova Presta√ß√£o de Contas</div>
      <div class="form-grid">
        <div class="field"><label>Evento *</label><input type="text" id="fEvento" placeholder="Ex: Reuni√£o Porto / Fenavem 2024"></div>
        <div class="field"><label>Data *</label><input type="date" id="fData"></div>
        <div class="field full"><label>Descri√ß√£o Geral</label><input type="text" id="fDescricao" placeholder="Detalhes adicionais sobre a presta√ß√£o..."></div>
      </div>
      <div style="margin:20px 0 8px;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:var(--accent);">LINHAS DE DESPESA</div>
      <div id="expenseLinesContainer"></div>
      <button class="btn btn-outline" style="margin-top:8px;padding:8px 16px;font-size:11px;" onclick="addExpenseLine()">+ Adicionar linha</button>
      <div class="field full" style="margin-top:20px;">
        <label>Comprovantes / Imagens</label>
        <div class="upload-area">
          <input type="file" id="fImages" accept="image/*" multiple onchange="handleImageUpload(event)">
          <div class="upload-label"><span>Clique ou arraste</span> para adicionar imagens<small>JPG, PNG, WEBP ¬∑ m√∫ltiplos arquivos</small></div>
        </div>
        <div class="preview-grid" id="previewGrid"></div>
      </div>
      <div style="margin-top:24px;">
        <button class="btn btn-gold" id="submitBtn" onclick="submitExpense()">Enviar Presta√ß√£o</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="justify-content:space-between;"><div style="display:flex;align-items:center;gap:10px;"><div class="dot"></div> Minhas Presta√ß√µes</div><span style="font-size:11px;color:var(--text-dim);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;">Clique para ver detalhes</span></div>
      ${mine.length===0 ? `<div class="empty-state"><div class="big">IB</div><p>Nenhuma presta√ß√£o enviada ainda.</p></div>`
      : `<div class="expense-list">${mine.map(expenseCard).join('')}</div>`}
    </div>`;
  document.getElementById('mainContent').innerHTML = html;
  document.getElementById('fData').valueAsDate = new Date();
  renderExpenseLines();
}

function buildLineHTML(line, showRemove) {
  return `<div class="expense-line" id="line_${line.id}">
      <div class="expense-line-header">
        <span class="expense-line-num" id="linenum_${line.id}">LINHA</span>
        ${showRemove ? `<button class="remove-line-btn" onclick="removeExpenseLine(${line.id})">‚úï</button>` : ''}
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div class="field" style="margin-bottom:0">
          <label>Categoria *</label>
          <select id="cat_${line.id}">
            <option value="">‚Äî Selecione ‚Äî</option>
            ${globalCategories.map(c=>`<option>${c}</option>`).join('')}
          </select>
        </div>
        <div class="field" style="margin-bottom:0">
          <label>Valor *</label>
          <input type="number" id="val_${line.id}" placeholder="0,00" step="0.01" min="0">
        </div>
        <div class="field" style="margin-bottom:0">
          <label>Moeda *</label>
          <select id="cur_${line.id}">
            <option value="BRL">R$ Real</option>
            <option value="USD">$ USD</option>
            <option value="EUR">‚Ç¨ Euro</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:0;grid-column:1/-1">
          <label>Descri√ß√£o da linha</label>
          <input type="text" id="desc_${line.id}" placeholder="Descri√ß√£o espec√≠fica desta despesa...">
        </div>
      </div>
    </div>`;
}

function updateLineNumbers() {
  expenseLines.forEach((line, i) => {
    const el = document.getElementById(`linenum_${line.id}`);
    if (el) el.textContent = `LINHA ${i+1}`;
  });
  // Update remove buttons visibility
  expenseLines.forEach(line => {
    const lineEl = document.getElementById(`line_${line.id}`);
    if (!lineEl) return;
    const existingBtn = lineEl.querySelector('.remove-line-btn');
    if (expenseLines.length > 1 && !existingBtn) {
      const header = lineEl.querySelector('.expense-line-header');
      const btn = document.createElement('button');
      btn.className = 'remove-line-btn';
      btn.innerHTML = '‚úï';
      btn.onclick = () => removeExpenseLine(line.id);
      header.appendChild(btn);
    } else if (expenseLines.length === 1 && existingBtn) {
      existingBtn.remove();
    }
  });
}

function renderExpenseLines() {
  const container = document.getElementById('expenseLinesContainer');
  if (!container) return;
  container.innerHTML = expenseLines.map((line, i) => buildLineHTML(line, expenseLines.length > 1)).join('');
  updateLineNumbers();
}

function addExpenseLine() {
  const container = document.getElementById('expenseLinesContainer');
  if (!container) return;
  const newLine = { id: Date.now() };
  expenseLines.push(newLine);
  // Append only the new line ‚Äî don't re-render existing ones
  const div = document.createElement('div');
  div.innerHTML = buildLineHTML(newLine, true);
  container.appendChild(div.firstElementChild);
  updateLineNumbers();
}

function removeExpenseLine(id) {
  expenseLines = expenseLines.filter(l => l.id !== id);
  const el = document.getElementById(`line_${id}`);
  if (el) el.remove();
  updateLineNumbers();
}

function expenseCard(e) {
  const firstLine = e.lines && e.lines.length ? e.lines[0] : null;
  const totalLines = e.lines ? e.lines.length : 0;
  return `
    <div class="expense-item" onclick="openExpenseDetail('${e.id}')">
      <span class="cat-badge">${firstLine ? firstLine.category : (e.category||'‚Äî')}</span>
      <div class="exp-info">
        <strong>${e.event}</strong>
        <small>${e.description||'‚Äî'} ${totalLines > 1 ? `¬∑ <span style="color:var(--accent)">${totalLines} linhas de despesa</span>` : ''}</small>
        ${e.images&&e.images.length ? `<div style="display:flex;gap:6px;margin-top:6px;">${e.images.slice(0,3).map(img=>`<img src="${img.dataUrl}" style="width:32px;height:32px;object-fit:cover;border:1px solid rgba(255,255,255,0.1);">`).join('')}${e.images.length>3?`<span style="font-size:10px;color:var(--text-dim);align-self:center;">+${e.images.length-3}</span>`:''}</div>` : ''}
      </div>
      <div style="text-align:right">
        <div class="exp-amount">${firstLine ? CURR_SYMBOL[firstLine.currency]+' '+Number(firstLine.amount).toLocaleString('pt-BR',{minimumFractionDigits:2}) : ''}</div>
        <span class="status-badge ${STATUS_CLASS[e.status]}">${STATUS_LABEL[e.status]}</span>
      </div>
      <div class="exp-date">
        ${new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR')}<br>
        <span style="color:#555;font-size:10px;">incl. ${new Date(e.createdAt).toLocaleDateString('pt-BR')}</span>
      </div>
    </div>`;
}

async function submitExpense() {
  const evento = document.getElementById('fEvento').value.trim();
  const data = document.getElementById('fData').value;
  const desc = document.getElementById('fDescricao').value.trim();
  if (!evento || !data) { toast('Preencha evento e data.', true); return; }

  const lines = [];
  for (const line of expenseLines) {
    const cat = document.getElementById(`cat_${line.id}`)?.value;
    const val = parseFloat(document.getElementById(`val_${line.id}`)?.value);
    const cur = document.getElementById(`cur_${line.id}`)?.value;
    const ld = document.getElementById(`desc_${line.id}`)?.value.trim();
    if (!cat || isNaN(val) || val <= 0) { toast('Preencha categoria e valor em todas as linhas.', true); return; }
    lines.push({ category: cat, amount: val, currency: cur, description: ld });
  }

  const btn = document.getElementById('submitBtn');
  btn.innerHTML = '<span class="spinner"></span> Enviando...'; btn.disabled = true;

  try {
    const id = 'exp_' + Date.now();
    const exp = {
      id, userId: state.currentUser.id, userName: state.currentUser.name,
      businessLine: state.currentUser.businessLine||'',
      event: evento, date: data, description: desc,
      lines,
      // keep legacy fields for compat
      category: lines[0].category, amount: lines[0].amount, currency: lines[0].currency,
      images: pendingImages.map(i=>({ name:i.name, dataUrl:i.dataUrl })),
      status: 'pending',
      createdAt: new Date().toISOString()
    };
    await fbSet('expenses', id, exp);
    await sendEmail(exp);
    pendingImages = [];
    expenseLines = [{ id: Date.now() }];
    toast('Presta√ß√£o enviada! Email enviado ao financeiro. ‚úì');
    renderTrader();
  } catch(e) {
    toast('Erro ao enviar. Tente novamente.', true);
    console.error(e);
  }
  btn.innerHTML = 'Enviar Presta√ß√£o'; btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendEmail(exp) {
  try {
    const linesText = exp.lines.map((l,i) =>
      `Linha ${i+1}: ${l.category} | ${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})} | ${l.description||'‚Äî'}`
    ).join('\n');
    await emailjs.send('service_7ojw3be', 'template_5r3es1d', {
      trader_name: exp.userName,
      business_line: exp.businessLine||'‚Äî',
      event: exp.event,
      category: exp.lines.map(l=>l.category).join(', '),
      date: new Date(exp.date+'T12:00:00').toLocaleDateString('pt-BR'),
      amount: exp.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' | '),
      description: exp.description||'‚Äî',
      created_at: new Date(exp.createdAt).toLocaleString('pt-BR'),
      image_count: exp.images ? exp.images.length : 0,
      name: exp.userName,
      title: `Nova Presta√ß√£o: ${exp.event}`,
      message: `Trader: ${exp.userName}\nLinha de Neg√≥cio: ${exp.businessLine}\nEvento: ${exp.event}\nData: ${new Date(exp.date+'T12:00:00').toLocaleDateString('pt-BR')}\nDescri√ß√£o: ${exp.description||'‚Äî'}\n\n${linesText}\n\nImagens: ${exp.images?exp.images.length:0}`
    });
  } catch(e) { console.warn('EmailJS error:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleImageUpload(event) {
  Array.from(event.target.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => { pendingImages.push({ name:file.name, dataUrl:e.target.result }); renderPreviews(); };
    reader.readAsDataURL(file);
  });
  event.target.value = '';
}
function renderPreviews() {
  const grid = document.getElementById('previewGrid');
  if (!grid) return;
  grid.innerHTML = pendingImages.map((img,i) => `
    <div class="preview-wrap">
      <img class="preview-thumb" src="${img.dataUrl}" title="${img.name}" onclick="openLightbox('${img.dataUrl}')">
      <button class="preview-remove" onclick="removeImage(${i})">‚úï</button>
    </div>`).join('');
}
function removeImage(idx) { pendingImages.splice(idx,1); renderPreviews(); }
function openLightbox(src) { document.getElementById('lightboxImg').src=src; document.getElementById('lightbox').classList.add('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPENSE DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openExpenseDetail(id) {
  const exp = allExpenses.find(e => e.id === id) || await fbGet('expenses', id);
  if (!exp) return;
  const isAdmin = state.currentUser.role === 'admin';
  const color = BIZ_COLORS[exp.businessLine]||'var(--white)';

  // Build lines section
  const linesHtml = exp.lines ? exp.lines.map((l,i) => `
    <div class="detail-line">
      <span class="detail-line-num">LINHA ${i+1}</span>
      <span class="cat-badge">${l.category}</span>
      <span class="detail-line-amount">${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
      ${l.description ? `<span class="detail-line-desc">${l.description}</span>` : ''}
    </div>`).join('')
  : `<div class="detail-line">
      <span class="cat-badge">${exp.category||'‚Äî'}</span>
      <span class="detail-line-amount">${CURR_SYMBOL[exp.currency]||''} ${Number(exp.amount||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
    </div>`;

  // Build images section
  const imgsHtml = exp.images && exp.images.length
    ? exp.images.map(img=>`<img class="detail-img" src="${img.dataUrl}" onclick="openLightbox('${img.dataUrl}')" title="${img.name||''}">`).join('')
    : '<span style="color:var(--text-dim);font-size:13px;">Nenhuma imagem anexada</span>';

  // Build action buttons
  let actionsHtml = '';
  if (isAdmin && exp.status === 'pending') {
    actionsHtml = `
      <button class="btn btn-gold" onclick="changeStatus('${exp.id}','approved');closeDetailPage();">‚úì Aprovar</button>
      <button class="btn btn-outline" style="border-color:var(--danger);color:var(--danger);" onclick="changeStatus('${exp.id}','rejected');closeDetailPage();">‚úï Recusar</button>`;
  } else if (isAdmin && exp.status === 'rejected') {
    actionsHtml = `<button class="btn btn-danger-solid" onclick="deleteExpense('${exp.id}')">üóë Excluir Presta√ß√£o</button>`;
  }

  document.getElementById('detailPageActions').innerHTML = actionsHtml;
  document.getElementById('detailPageContent').innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:6px;flex-wrap:wrap;">
      <div class="detail-page-title">${exp.event}</div>
      <span class="status-badge ${STATUS_CLASS[exp.status]}" style="font-size:12px;">${STATUS_LABEL[exp.status]}</span>
    </div>
    <div class="detail-page-sub">
      Inclu√≠do em ${new Date(exp.createdAt).toLocaleString('pt-BR')}
    </div>

    <div class="detail-section">
      <div class="detail-section-title">INFORMA√á√ïES GERAIS</div>
      <div class="detail-meta-grid">
        <div class="detail-meta-item"><label>Usu√°rio</label><span>${exp.userName}</span></div>
        <div class="detail-meta-item"><label>Linha de Neg√≥cio</label><span style="color:${color};font-weight:600;">${exp.businessLine||'‚Äî'}</span></div>
        <div class="detail-meta-item"><label>Data da Despesa</label><span>${new Date(exp.date+'T12:00:00').toLocaleDateString('pt-BR')}</span></div>
        <div class="detail-meta-item"><label>Qtd de Linhas</label><span>${exp.lines ? exp.lines.length : 1} linha(s)</span></div>
        ${exp.description ? `<div class="detail-meta-item" style="grid-column:1/-1"><label>Descri√ß√£o Geral</label><span>${exp.description}</span></div>` : ''}
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">LINHAS DE DESPESA</div>
      ${linesHtml}
    </div>

    <div class="detail-section">
      <div class="detail-section-title">COMPROVANTES (${exp.images ? exp.images.length : 0} imagem(ns))</div>
      <div class="detail-images">${imgsHtml}</div>
    </div>

    ${actionsHtml ? `<div class="detail-actions">${actionsHtml}</div>` : ''}
  `;

  document.getElementById('detailPage').style.display = 'block';
  document.getElementById('detailPage').scrollTop = 0;
}

function closeDetailPage() {
  document.getElementById('detailPage').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderAdmin() {
  document.getElementById('mainContent').innerHTML = '<div style="text-align:center;padding:60px;"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>';
  try {
    allExpenses = await fbGetAll('expenses');
    renderAdminHTML(allExpenses);
  } catch(e) { toast('Erro ao carregar dados.', true); }
}

function renderAdminHTML(expenses) {
  // Only count approved expenses in totals
  const approved = expenses.filter(e => e.status === 'approved');
  const calcTotal = (exps, currency) => exps.filter(e => e.currency === currency || (e.lines && e.lines.some(l=>l.currency===currency))).reduce((s,e) => {
    if (e.lines) return s + e.lines.filter(l=>l.currency===currency).reduce((a,l)=>a+l.amount,0);
    return e.currency===currency ? s+e.amount : s;
  }, 0);

  const totalBRL = calcTotal(approved,'BRL');
  const totalUSD = calcTotal(approved,'USD');
  const totalEUR = calcTotal(approved,'EUR');

  const html = `
    <div class="page-header">
      <div class="page-title">Painel Financeiro</div>
      <div class="page-sub">Independent Brazil ¬∑ Gest√£o de Despesas ¬∑ Apenas aprovadas contabilizadas</div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total BRL (aprovado)</div><div class="stat-value">R$ ${totalBRL.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div><div class="stat-sub">${approved.length} aprovadas</div></div>
      <div class="stat-card"><div class="stat-label">Total USD (aprovado)</div><div class="stat-value">$ ${totalUSD.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
      <div class="stat-card"><div class="stat-label">Total EUR (aprovado)</div><div class="stat-value">‚Ç¨ ${totalEUR.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
      <div class="stat-card"><div class="stat-label">Pendentes</div><div class="stat-value">${expenses.filter(e=>e.status==='pending').length}</div><div class="stat-sub">aguardando revis√£o</div></div>
    </div>
    ${renderBizLineStats(approved)}
    <div class="tabs">
      <button class="tab ${adminTab==='expenses'?'active':''}" onclick="switchTab('expenses',event)">Presta√ß√µes</button>
      <button class="tab ${adminTab==='users'?'active':''}" onclick="switchTab('users',event)">Usu√°rios</button>
      <button class="tab ${adminTab==='categories'?'active':''}" onclick="switchTab('categories',event)">Categorias</button>
    </div>
    <div id="tabContent"></div>`;
  document.getElementById('mainContent').innerHTML = html;
  renderTab();
}

function renderBizLineStats(expenses) {
  const calcLine = (exps, currency) => exps.reduce((s,e) => {
    if (e.lines) return s + e.lines.filter(l=>l.currency===currency).reduce((a,l)=>a+l.amount,0);
    return e.currency===currency ? s+e.amount : s;
  }, 0);

  const rows = BIZ_LINES.map(line => {
    const exps = expenses.filter(e => e.businessLine === line);
    const brl = calcLine(exps,'BRL'), usd = calcLine(exps,'USD'), eur = calcLine(exps,'EUR');
    const color = BIZ_COLORS[line]||'#888';
    return `<div class="biz-card">
      <div class="biz-bar" style="background:${color};"></div>
      <div><div class="biz-name" style="color:${color};">${line}</div><div class="biz-count">${exps.length} aprovada${exps.length!==1?'s':''}</div></div>
      <div class="biz-amounts">
        <div><div class="biz-amount-label">BRL</div><div class="biz-amount-val">R$ ${brl.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
        <div><div class="biz-amount-label">USD</div><div class="biz-amount-val">$ ${usd.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
        <div><div class="biz-amount-label">EUR</div><div class="biz-amount-val">‚Ç¨ ${eur.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
      </div>
    </div>`;
  }).join('');

  return `<div class="biz-section">
    <div class="biz-section-header">
      <div class="biz-section-title">TOTAL POR LINHA DE NEG√ìCIO (APROVADAS)</div>
      <button class="btn btn-gold" style="padding:9px 18px;font-size:11px;" onclick="openReportModal()">üìä Gerar Relat√≥rio PDF</button>
    </div>
    <div class="biz-grid">${rows}</div>
  </div>`;
}

function switchTab(tab, event) {
  adminTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (event) event.target.classList.add('active');
  renderTab();
}
function renderTab() {
  if (adminTab==='expenses') renderExpensesTab();
  else if (adminTab==='users') renderUsersTab();
  else renderCategoriesTab();
}

function renderExpensesTab() {
  document.getElementById('tabContent').innerHTML = `
    <div class="card">
      <div class="card-title" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="openFullListPage()">
          <div class="dot"></div>
          <span style="border-bottom:1px solid rgba(200,168,75,0.3);">Todas as Presta√ß√µes</span>
          <span style="font-size:11px;color:var(--accent);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;">‚Üó Tela cheia</span>
        </div>
        <span style="font-size:11px;color:var(--text-dim);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;">Clique em qualquer linha para detalhes</span>
      </div>
      <div class="filters">
        <input type="text" id="filterText" placeholder="Buscar trader, evento..." oninput="filterTable()" style="min-width:180px;">
        <select id="filterBiz" onchange="filterTable()">
          <option value="">Todas as linhas</option>
          ${BIZ_LINES.map(l=>`<option>${l}</option>`).join('')}
        </select>
        <select id="filterCat" onchange="filterTable()">
          <option value="">Todas categorias</option>
          ${globalCategories.map(c=>`<option>${c}</option>`).join('')}
        </select>
        <select id="filterStatus" onchange="filterTable()">
          <option value="">Todos status</option>
          <option value="pending">Pendente</option>
          <option value="approved">Aprovado</option>
          <option value="rejected">Recusado</option>
        </select>
        <div style="display:flex;gap:8px;margin-left:auto;flex-wrap:wrap;">
          <button class="btn btn-outline" onclick="exportExcel()">‚¨á Excel</button>
          <button class="btn btn-outline" onclick="exportPDF()">‚¨á PDF</button>
        </div>
      </div>
      <div class="admin-table-wrap">
        <table>
          <thead><tr>
            <th>Trader</th><th>Linha</th><th>Evento</th><th>Categoria(s)</th>
            <th>Data</th><th>Valor(es)</th><th>Status</th><th>A√ß√µes</th>
          </tr></thead>
          <tbody id="expTableBody"></tbody>
        </table>
      </div>
    </div>`;
  filterTable();
}

function filterTable() {
  const txt = (document.getElementById('filterText')?.value||'').toLowerCase();
  const biz = document.getElementById('filterBiz')?.value||'';
  const cat = document.getElementById('filterCat')?.value||'';
  const status = document.getElementById('filterStatus')?.value||'';

  filteredExpenses = allExpenses.filter(e => {
    const cats = e.lines ? e.lines.map(l=>l.category).join(' ') : (e.category||'');
    return (!txt || e.userName.toLowerCase().includes(txt) || e.event.toLowerCase().includes(txt) || (e.description||'').toLowerCase().includes(txt))
        && (!biz || e.businessLine===biz)
        && (!cat || cats.includes(cat))
        && (!status || e.status===status);
  });

  const tbody = document.getElementById('expTableBody');
  if (!tbody) return;
  if (!filteredExpenses.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:40px;">Nenhuma presta√ß√£o encontrada.</td></tr>`;
    return;
  }
  tbody.innerHTML = filteredExpenses.map(e => {
    const color = BIZ_COLORS[e.businessLine]||'var(--text-dim)';
    const initials = e.userName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
    const cats = e.lines ? [...new Set(e.lines.map(l=>l.category))].map(c=>`<span class="cat-badge" style="margin-right:3px;">${c}</span>`).join('') : `<span class="cat-badge">${e.category}</span>`;
    const amounts = e.lines ? e.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join('<br>') : `${CURR_SYMBOL[e.currency]} ${Number(e.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
    return `<tr class="clickable" onclick="openExpenseDetail('${e.id}')" style="cursor:pointer;">
      <td><div style="display:flex;align-items:center;gap:8px;"><div class="trader-avatar">${initials}</div>${e.userName}</div></td>
      <td><span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:${color};">${e.businessLine||'‚Äî'}</span></td>
      <td><strong>${e.event}</strong><br><small style="color:var(--text-dim)">${e.description||''}</small></td>
      <td>${cats}</td>
      <td style="color:var(--text-dim);font-size:12px;">${new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR')}<br><span style="font-size:10px;">incl. ${new Date(e.createdAt).toLocaleDateString('pt-BR')}</span></td>
      <td style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--accent2);">${amounts}</td>
      <td><span class="status-badge ${STATUS_CLASS[e.status]}">${STATUS_LABEL[e.status]}</span></td>
      <td onclick="event.stopPropagation()" style="white-space:nowrap;">
        ${e.status==='pending' ? `
          <div style="display:flex;gap:5px;">
            <button class="action-btn action-approve" onclick="changeStatus('${e.id}','approved')" title="Aprovar">‚úì Aprovar</button>
            <button class="action-btn action-reject" onclick="changeStatus('${e.id}','rejected')" title="Recusar">‚úï Recusar</button>
          </div>
        ` : e.status==='rejected' ? `
          <button class="action-btn action-delete" onclick="deleteExpense('${e.id}')">Excluir</button>
        ` : `<span style="color:var(--text-dim);font-size:11px;">‚Äî</span>`}
      </td>
    </tr>`;
  }).join('');
}

async function changeStatus(id, status) {
  try {
    await fbUpdate('expenses', id, { status });
    const idx = allExpenses.findIndex(e => e.id === id);
    if (idx >= 0) allExpenses[idx].status = status;

    // Send email notification to trader if rejected
    if (status === 'rejected') {
      const exp = allExpenses[idx];
      await sendStatusEmail(exp, 'rejected');
    }

    toast(status==='approved' ? 'Presta√ß√£o aprovada! ‚úì' : 'Presta√ß√£o recusada. Trader notificado por email.');
    filterTable();
    renderAdminHTML(allExpenses);
  } catch(e) { toast('Erro ao atualizar.', true); }
}

async function sendStatusEmail(exp, status) {
  try {
    // Get trader email
    const users = await fbGetAll('users');
    const trader = users.find(u => u.id === exp.userId);
    if (!trader || !trader.email) return;

    const linesText = exp.lines ? exp.lines.map((l,i) =>
      `Linha ${i+1}: ${l.category} | ${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})} | ${l.description||'‚Äî'}`
    ).join('\n') : `${exp.category} | ${CURR_SYMBOL[exp.currency]} ${Number(exp.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;

    await emailjs.send('service_7ojw3be', 'template_5r3es1d', {
      trader_name: exp.userName,
      business_line: exp.businessLine||'‚Äî',
      event: exp.event,
      category: exp.lines ? exp.lines.map(l=>l.category).join(', ') : (exp.category||''),
      date: new Date(exp.date+'T12:00:00').toLocaleDateString('pt-BR'),
      amount: exp.lines ? exp.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' | ') : `${CURR_SYMBOL[exp.currency]} ${Number(exp.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
      description: exp.description||'‚Äî',
      created_at: new Date(exp.createdAt).toLocaleString('pt-BR'),
      image_count: exp.images ? exp.images.length : 0,
      name: exp.userName,
      title: `Presta√ß√£o RECUSADA: ${exp.event}`,
      message: `Ol√° ${exp.userName},\n\nSua presta√ß√£o de contas foi RECUSADA pelo financeiro.\n\nEvento: ${exp.event}\nLinha de Neg√≥cio: ${exp.businessLine}\nData: ${new Date(exp.date+'T12:00:00').toLocaleDateString('pt-BR')}\n\n${linesText}\n\nEm caso de d√∫vidas, entre em contato com o financeiro.\n\nIndependent Brazil`
    });
  } catch(e) { console.warn('Email notify error:', e); }
}

async function deleteExpense(id) {
  if (!confirm('Excluir esta presta√ß√£o permanentemente?')) return;
  try {
    await fbDelete('expenses', id);
    allExpenses = allExpenses.filter(e => e.id !== id);
    closeModal();
    toast('Presta√ß√£o exclu√≠da.');
    filterTable();
    renderAdminHTML(allExpenses);
  } catch(e) { toast('Erro ao excluir.', true); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORIES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCategoriesTab() {
  document.getElementById('tabContent').innerHTML = `
    <div class="card">
      <div class="card-title"><div class="dot"></div> Gerenciar Categorias</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:20px;">As categorias cadastradas aqui ficam dispon√≠veis para os usu√°rios na hora de lan√ßar uma presta√ß√£o.</p>
      <div class="cat-list" id="catList">${globalCategories.map((c,i)=>`
        <div class="cat-tag">
          <span>${c}</span>
          <button onclick="removeCategory(${i})" title="Remover">‚úï</button>
        </div>`).join('')}
      </div>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:16px;">
        <div class="field" style="margin-bottom:0;flex:1;min-width:200px;">
          <label>Nova Categoria</label>
          <input type="text" id="newCatInput" placeholder="Ex: Hospedagem">
        </div>
        <button class="btn btn-gold" id="addCatBtn" style="margin-top:20px;">+ Adicionar</button>
      </div>
    </div>`;
  // Attach events after DOM is rendered
  document.getElementById('addCatBtn').addEventListener('click', addCategory);
  document.getElementById('newCatInput').addEventListener('keydown', e => { if(e.key==='Enter') addCategory(); });
}

async function addCategory() {
  const input = document.getElementById('newCatInput');
  if (!input) return;
  const val = input.value.trim();
  if (!val) { toast('Digite o nome da categoria.', true); return; }
  if (globalCategories.map(c=>c.toLowerCase()).includes(val.toLowerCase())) { toast('Categoria j√° existe.', true); return; }
  globalCategories.push(val);
  await saveCategories();
  toast('Categoria adicionada! ‚úì');
  renderCategoriesTab();
}

async function removeCategory(idx) {
  if (!confirm(`Remover a categoria "${globalCategories[idx]}"?`)) return;
  globalCategories.splice(idx, 1);
  await saveCategories();
  toast('Categoria removida.');
  renderCategoriesTab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderUsersTab() {
  document.getElementById('tabContent').innerHTML = '<div style="text-align:center;padding:40px;"><span class="spinner" style="width:24px;height:24px;border-width:3px;"></span></div>';
  try {
    const all = await fbGetAll('users');
    const traders = all.filter(u => u.role === 'trader');
    document.getElementById('tabContent').innerHTML = `
      <div class="card">
        <div class="card-title"><div class="dot"></div> Usu√°rios Cadastrados</div>
        <div style="margin-bottom:24px;"><button class="btn btn-gold" onclick="openNewUserModal()">+ Novo Usu√°rio</button></div>
        ${traders.length===0 ? `<div class="empty-state"><div class="big">0</div><p>Nenhum trader ainda.</p></div>` : `
        <div class="users-grid">${traders.map(u=>`
          <div class="user-card">
            <div class="user-avatar-lg">${u.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()}</div>
            <div class="user-info">
              <strong>${u.name}</strong>
              <small>${u.email}</small>
              <div class="user-biz">${u.businessLine||''}</div>
              <div style="margin-top:8px;"><button class="action-btn action-reject" onclick="deleteUser('${u.id}')">Remover</button></div>
            </div>
          </div>`).join('')}
        </div>`}
      </div>`;
  } catch(e) { toast('Erro ao carregar traders.', true); }
}

function openNewUserModal() {
  document.getElementById('modalBox').classList.remove('modal-wide');
  document.getElementById('modalTitle').textContent = 'Cadastrar Novo Usu√°rio';
  document.getElementById('modalBody').innerHTML = `
    <div class="field"><label>Nome Completo *</label><input type="text" id="newName" placeholder="Jo√£o Silva"></div>
    <div class="field"><label>E-mail *</label><input type="email" id="newEmail" placeholder="joao@independentbrazil.com"></div>
    <div class="field"><label>Senha *</label><input type="password" id="newPass" placeholder="M√≠nimo 4 caracteres"></div>
    <div class="field"><label>Linha de Neg√≥cio *</label>
      <select id="newBizLine">
        <option value="">‚Äî Selecione ‚Äî</option>
        ${BIZ_LINES.map(l=>`<option>${l}</option>`).join('')}
      </select>
    </div>
    <div id="newUserError" class="error-msg"></div>`;
  document.getElementById('modalActions').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
    <button class="btn btn-gold" onclick="createUser()">Cadastrar</button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

async function createUser() {
  const name = document.getElementById('newName').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const pass = document.getElementById('newPass').value;
  const bizLine = document.getElementById('newBizLine').value;
  if (!name || !email || pass.length < 4 || !bizLine) {
    document.getElementById('newUserError').textContent = 'Preencha todos os campos (senha m√≠nimo 4 caracteres).'; return;
  }
  try {
    const all = await fbGetAll('users');
    if (all.find(u => u.email===email)) { document.getElementById('newUserError').textContent = 'E-mail j√° cadastrado.'; return; }
    const id = 'u'+Date.now();
    await fbSet('users', id, { id, name, email, password:pass, role:'trader', businessLine:bizLine, createdAt:new Date().toISOString() });
    closeModal();
    toast('Usu√°rio cadastrado! ‚úì');
    renderUsersTab();
  } catch(e) { toast('Erro ao cadastrar.', true); }
}

async function deleteUser(id) {
  if (!confirm('Remover este trader?')) return;
  try {
    await fbDelete('users', id);
    toast('Usu√°rio removido.');
    renderUsersTab();
  } catch(e) { toast('Erro ao remover.', true); }
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.getElementById('modalBox').classList.remove('modal-wide');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT MODAL (PDF por data)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openReportModal() {
  document.getElementById('modalBox').classList.remove('modal-wide');
  const today = new Date().toISOString().slice(0,10);
  const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10);
  document.getElementById('modalTitle').textContent = 'Gerar Relat√≥rio PDF';
  document.getElementById('modalBody').innerHTML = `
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:20px;">Filtre por per√≠odo e linha de neg√≥cio para gerar o relat√≥rio.</p>
    <div class="form-grid">
      <div class="field">
        <label>Data In√≠cio</label>
        <input type="date" id="reportStart" style="color-scheme:dark;">
      </div>
      <div class="field">
        <label>Data Fim</label>
        <input type="date" id="reportEnd" style="color-scheme:dark;">
      </div>
      <div class="field full"><label>Linha de Neg√≥cio</label>
        <select id="reportBiz">
          <option value="">Todas as linhas</option>
          ${BIZ_LINES.map(l=>"<option>"+l+"</option>").join("")}
        </select>
      </div>
      <div class="field full"><label>Status</label>
        <select id="reportStatus">
          <option value="">Todos</option>
          <option value="approved">Apenas Aprovadas</option>
          <option value="pending">Apenas Pendentes</option>
          <option value="rejected">Apenas Recusadas</option>
        </select>
      </div>
    </div>`;
  document.getElementById('modalActions').innerHTML = `
    <button class="btn btn-outline" id="reportCancelBtn">Cancelar</button>
    <button class="btn btn-gold" id="reportGenBtn">üìÑ Gerar PDF</button>`;
  document.getElementById('modalOverlay').classList.add('open');
  // Set values and attach events AFTER DOM render
  document.getElementById('reportStart').value = firstDay;
  document.getElementById('reportEnd').value = today;
  document.getElementById('reportCancelBtn').addEventListener('click', closeModal);
  document.getElementById('reportGenBtn').addEventListener('click', generateReport);
}

function generateReport() {
  const start = document.getElementById('reportStart').value;
  const end = document.getElementById('reportEnd').value;
  const biz = document.getElementById('reportBiz').value;
  const status = document.getElementById('reportStatus').value;

  const filtered = allExpenses.filter(e => {
    const d = e.date;
    return (!start || d >= start) && (!end || d <= end)
        && (!biz || e.businessLine === biz)
        && (!status || e.status === status);
  });

  if (!filtered.length) { toast('Nenhuma presta√ß√£o encontrada para os filtros selecionados.', true); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });

  // Header
  doc.setFillColor(10,10,10);
  doc.rect(0,0,297,30,'F');
  doc.setTextColor(245,245,240);
  doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('INDEPENDENT BRAZIL', 14, 18);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.setTextColor(200,168,75);
  doc.text('Relat√≥rio de Presta√ß√µes de Contas', 14, 25);
  doc.setTextColor(150,150,150);
  doc.text(`Per√≠odo: ${start ? new Date(start+'T12:00:00').toLocaleDateString('pt-BR') : 'In√≠cio'} at√© ${end ? new Date(end+'T12:00:00').toLocaleDateString('pt-BR') : 'Hoje'} | ${biz||'Todas as linhas'} | ${status ? STATUS_LABEL[status] : 'Todos os status'} | Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 28);

  // Summary by biz line
  const bizSummary = BIZ_LINES.filter(l => !biz || l===biz).map(line => {
    const exps = filtered.filter(e=>e.businessLine===line);
    if (!exps.length) return null;
    const brl = exps.reduce((s,e)=>{ if(e.lines) return s+e.lines.filter(l=>l.currency==='BRL').reduce((a,l)=>a+l.amount,0); return e.currency==='BRL'?s+e.amount:s; },0);
    const usd = exps.reduce((s,e)=>{ if(e.lines) return s+e.lines.filter(l=>l.currency==='USD').reduce((a,l)=>a+l.amount,0); return e.currency==='USD'?s+e.amount:s; },0);
    const eur = exps.reduce((s,e)=>{ if(e.lines) return s+e.lines.filter(l=>l.currency==='EUR').reduce((a,l)=>a+l.amount,0); return e.currency==='EUR'?s+e.amount:s; },0);
    return [line, exps.length.toString(), `R$ ${brl.toLocaleString('pt-BR',{minimumFractionDigits:2})}`, `$ ${usd.toLocaleString('pt-BR',{minimumFractionDigits:2})}`, `‚Ç¨ ${eur.toLocaleString('pt-BR',{minimumFractionDigits:2})}`];
  }).filter(Boolean);

  if (bizSummary.length) {
    doc.autoTable({
      head:[['Linha de Neg√≥cio','Qtd','Total BRL','Total USD','Total EUR']],
      body: bizSummary, startY:34,
      styles:{ fontSize:9, cellPadding:4 },
      headStyles:{ fillColor:[30,30,30], textColor:[200,168,75], fontStyle:'bold' },
      alternateRowStyles:{ fillColor:[245,245,240] },
      margin:{ left:14 }, tableWidth:'auto',
    });
  }

  // Detail table
  const rows = filtered.map(e => {
    const cats = e.lines ? e.lines.map(l=>l.category).join(', ') : (e.category||'');
    const amounts = e.lines ? e.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' | ') : `${CURR_SYMBOL[e.currency]} ${Number(e.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
    return [
      e.userName, e.businessLine||'', e.event, cats,
      new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR'),
      amounts, STATUS_LABEL[e.status]
    ];
  });

  doc.autoTable({
    head:[['Trader','Linha','Evento','Categoria(s)','Data','Valor(es)','Status']],
    body: rows,
    startY: (doc.lastAutoTable?.finalY || 50) + 10,
    styles:{ fontSize:7, cellPadding:3 },
    headStyles:{ fillColor:[10,10,10], textColor:[200,168,75], fontStyle:'bold' },
    alternateRowStyles:{ fillColor:[245,245,240] },
  });

  const fname = `IB_Relatorio_${start||'inicio'}_${end||'hoje'}${biz?'_'+biz.replace(/\s/g,''):''}`;
  doc.save(`${fname}.pdf`);
  closeModal();
  toast('Relat√≥rio PDF gerado! ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT EXCEL / PDF (tabela filtrada)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel() {
  if (!filteredExpenses.length) { toast('Nenhum dado para exportar.', true); return; }
  const rows = filteredExpenses.map(e => ({
    'Trader': e.userName, 'Linha de Neg√≥cio': e.businessLine||'',
    'Evento': e.event, 'Data': new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR'),
    'Categoria(s)': e.lines ? e.lines.map(l=>l.category).join(', ') : (e.category||''),
    'Valor(es)': e.lines ? e.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' | ') : `${CURR_SYMBOL[e.currency]} ${Number(e.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
    'Descri√ß√£o': e.description||'', 'Status': STATUS_LABEL[e.status],
    'Data Inclus√£o': new Date(e.createdAt).toLocaleDateString('pt-BR'),
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Presta√ß√µes');
  XLSX.writeFile(wb, `IB_Prestacoes_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast('Excel exportado! ‚úì');
}

function exportPDF() {
  if (!filteredExpenses.length) { toast('Nenhum dado para exportar.', true); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });
  doc.setFillColor(10,10,10); doc.rect(0,0,297,25,'F');
  doc.setTextColor(245,245,240); doc.setFontSize(18); doc.setFont('helvetica','bold');
  doc.text('INDEPENDENT BRAZIL', 14, 16);
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(150,150,150);
  doc.text('Relat√≥rio de Presta√ß√µes ¬∑ ' + new Date().toLocaleDateString('pt-BR'), 14, 22);
  const rows = filteredExpenses.map(e => [
    e.userName, e.businessLine||'', e.event,
    e.lines ? e.lines.map(l=>l.category).join(', ') : (e.category||''),
    new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR'),
    e.lines ? e.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join(' | ') : `${CURR_SYMBOL[e.currency]} ${Number(e.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`,
    STATUS_LABEL[e.status]
  ]);
  doc.autoTable({
    head:[['Trader','Linha','Evento','Categoria(s)','Data','Valor(es)','Status']],
    body:rows, startY:30,
    styles:{ fontSize:7, cellPadding:3 },
    headStyles:{ fillColor:[10,10,10], textColor:[200,168,75], fontStyle:'bold' },
    alternateRowStyles:{ fillColor:[240,240,235] },
  });
  doc.save(`IB_Prestacoes_${new Date().toISOString().slice(0,10)}.pdf`);
  toast('PDF exportado! ‚úì');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FULL LIST PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fullFilteredExpenses = [];

function openFullListPage() {
  const page = document.getElementById('fullListPage');
  page.style.display = 'block';
  page.scrollTop = 0;
  // Populate filter selects
  const bizSel = document.getElementById('fullFilterBiz');
  bizSel.innerHTML = '<option value="">Todas as linhas</option>' + BIZ_LINES.map(l=>`<option>${l}</option>`).join('');
  const catSel = document.getElementById('fullFilterCat');
  catSel.innerHTML = '<option value="">Todas categorias</option>' + globalCategories.map(c=>`<option>${c}</option>`).join('');
  filterFullTable();
}

function closeFullListPage() {
  document.getElementById('fullListPage').style.display = 'none';
}

function filterFullTable() {
  const txt = (document.getElementById('fullFilterText')?.value||'').toLowerCase();
  const biz = document.getElementById('fullFilterBiz')?.value||'';
  const cat = document.getElementById('fullFilterCat')?.value||'';
  const status = document.getElementById('fullFilterStatus')?.value||'';

  fullFilteredExpenses = allExpenses.filter(e => {
    const cats = e.lines ? e.lines.map(l=>l.category).join(' ') : (e.category||'');
    return (!txt || e.userName.toLowerCase().includes(txt) || e.event.toLowerCase().includes(txt) || (e.description||'').toLowerCase().includes(txt))
        && (!biz || e.businessLine===biz)
        && (!cat || cats.includes(cat))
        && (!status || e.status===status);
  });

  const tbody = document.getElementById('fullExpTableBody');
  if (!tbody) return;
  if (!fullFilteredExpenses.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:40px;">Nenhuma presta√ß√£o encontrada.</td></tr>`;
    return;
  }
  tbody.innerHTML = fullFilteredExpenses.map(e => {
    const color = BIZ_COLORS[e.businessLine]||'var(--text-dim)';
    const initials = e.userName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
    const cats = e.lines ? [...new Set(e.lines.map(l=>l.category))].map(c=>`<span class="cat-badge" style="margin-right:3px;">${c}</span>`).join('') : `<span class="cat-badge">${e.category}</span>`;
    const amounts = e.lines ? e.lines.map(l=>`${CURR_SYMBOL[l.currency]} ${Number(l.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`).join('<br>') : `${CURR_SYMBOL[e.currency]} ${Number(e.amount).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
    return `<tr class="clickable" onclick="openExpenseDetail('${e.id}')" style="cursor:pointer;">
      <td><div style="display:flex;align-items:center;gap:8px;"><div class="trader-avatar">${initials}</div>${e.userName}</div></td>
      <td><span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:${color};">${e.businessLine||'‚Äî'}</span></td>
      <td><strong>${e.event}</strong><br><small style="color:var(--text-dim)">${e.description||''}</small></td>
      <td>${cats}</td>
      <td style="color:var(--text-dim);font-size:12px;">${new Date(e.date+'T12:00:00').toLocaleDateString('pt-BR')}<br><span style="font-size:10px;">incl. ${new Date(e.createdAt).toLocaleDateString('pt-BR')}</span></td>
      <td style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--accent2);">${amounts}</td>
      <td><span class="status-badge ${STATUS_CLASS[e.status]}">${STATUS_LABEL[e.status]}</span></td>
      <td onclick="event.stopPropagation()" style="white-space:nowrap;">
        ${e.status==='pending' ? `
          <div style="display:flex;gap:5px;">
            <button class="action-btn action-approve" onclick="changeStatus('${e.id}','approved')" title="Aprovar">‚úì Aprovar</button>
            <button class="action-btn action-reject" onclick="changeStatus('${e.id}','rejected')" title="Recusar">‚úï Recusar</button>
          </div>
        ` : e.status==='rejected' ? `
          <button class="action-btn action-delete" onclick="deleteExpense('${e.id}')">Excluir</button>
        ` : `<span style="color:var(--text-dim);font-size:11px;">‚Äî</span>`}
      </td>
    </tr>`;
  }).join('');
}

function exportExcelFull() {
  filteredExpenses = fullFilteredExpenses;
  exportExcel();
}
function exportPDFFull() {
  filteredExpenses = fullFilteredExpenses;
  exportPDF();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg, isError=false) {
  const el = document.getElementById('toastEl');
  el.className = 'toast'+(isError?' error':'');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.style.display='none'; }, 4000);
}
</script>
</body>
</html>
