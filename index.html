<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IB Â· PrestaÃ§Ã£o de Contas</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  const app = initializeApp({
    apiKey: "AIzaSyAIV9U__iJPHPjrVHupdVpadE4Pei1zAOA",
    authDomain: "independent-brazil.firebaseapp.com",
    projectId: "independent-brazil",
    storageBucket: "independent-brazil.firebasestorage.app",
    messagingSenderId: "3294487230",
    appId: "1:3294487230:web:fedc93f7a1b4b66dbc34ef"
  });
  const db = getFirestore(app);
  window._db = db;
  window._fb = { collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, orderBy };
  async function boot() {
    try {
      const aRef = doc(db,'users','u0');
      if (!(await getDoc(aRef)).exists()) await setDoc(aRef,{id:'u0',name:'Admin Financeiro',email:'financial@independentbrazil.com',password:'admin123',role:'admin',createdAt:new Date().toISOString()});
      const cRef = doc(db,'config','categories');
      if (!(await getDoc(cRef)).exists()) await setDoc(cRef,{list:['Viagem','Aluguel de Carro','AlimentaÃ§Ã£o','Brinde','Outros']});
    } catch(e){ console.error(e); }
    window._firebaseReady = true;
    document.dispatchEvent(new Event('firebaseReady'));
  }
  boot();
</script>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{--black:#0a0a0a;--white:#f5f5f0;--gray:#1a1a1a;--gray2:#2a2a2a;--accent:#c8a84b;--accent2:#e8c96b;--dim:#888;--danger:#e05555;--success:#4caf7d;--border:rgba(255,255,255,0.08);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--black);color:var(--white);min-height:100vh;}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--black);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
.loader-logo{font-family:'Bebas Neue',sans-serif;font-size:80px;color:var(--white);letter-spacing:10px;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.loader-text{font-size:12px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-top:16px;}

/* LOGIN */
#loginScreen{min-height:100vh;display:none;align-items:center;justify-content:center;background:var(--black);position:relative;overflow:hidden;}
#loginScreen::before{content:'IB';position:absolute;font-family:'Bebas Neue',sans-serif;font-size:clamp(200px,40vw,500px);color:rgba(255,255,255,0.03);letter-spacing:-10px;user-select:none;pointer-events:none;}
.login-box{background:var(--gray);border:1px solid var(--border);padding:48px 40px;width:100%;max-width:420px;position:relative;z-index:1;}
.login-logo{display:flex;align-items:center;gap:14px;margin-bottom:36px;}
.logo-mark{width:52px;height:52px;background:var(--white);display:flex;align-items:center;justify-content:center;}
.logo-mark span{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--black);}
.login-logo-text strong{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;display:block;}
.login-logo-text small{font-size:11px;color:var(--dim);letter-spacing:2px;text-transform:uppercase;}
.login-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:6px;}
.login-sub{font-size:13px;color:var(--dim);margin-bottom:32px;}

/* FIELDS */
.field{margin-bottom:18px;}
.field label{display:block;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:8px;}
.field input,.field select,.field textarea{width:100%;background:var(--black);border:1px solid var(--border);color:var(--white);padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);}
.field select option{background:var(--black);}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:8px;padding:13px 22px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border:none;transition:all .2s;}
.btn-primary{background:var(--white);color:var(--black);}
.btn-primary:hover{background:var(--accent2);}
.btn-gold{background:var(--accent);color:var(--black);}
.btn-gold:hover{background:var(--accent2);}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--white);}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:var(--danger);color:#fff;}
.btn-full{width:100%;justify-content:center;}
.error-msg{color:var(--danger);font-size:12px;margin-top:10px;}

/* APP */
#app{display:none;min-height:100vh;flex-direction:column;}
header{background:var(--gray);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.h-left{display:flex;align-items:center;gap:14px;}
.h-logo{width:36px;height:36px;background:var(--white);display:flex;align-items:center;justify-content:center;}
.h-logo span{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--black);}
.h-brand{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;}
.h-role{font-size:11px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;}
.h-right{display:flex;align-items:center;gap:12px;}
.user-pill{background:var(--black);border:1px solid var(--border);padding:6px 12px;font-size:13px;}
main{flex:1;padding:32px 24px;max-width:1200px;width:100%;margin:0 auto;}

/* CARDS */
.page-title{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;}
.page-sub{font-size:13px;color:var(--dim);margin-top:4px;margin-bottom:28px;}
.card{background:var(--gray);border:1px solid var(--border);padding:28px;margin-bottom:20px;}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-title-left{display:flex;align-items:center;gap:10px;}
.dot{width:6px;height:6px;background:var(--accent);flex-shrink:0;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:20px;}
.stat-card{background:var(--gray);border:1px solid var(--border);padding:18px 22px;}
.stat-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:8px;}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--accent2);letter-spacing:1px;}
.stat-sub{font-size:11px;color:var(--dim);margin-top:4px;}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:28px;}
.tab{padding:12px 24px;font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;color:var(--dim);border-bottom:2px solid transparent;transition:all .2s;background:none;border-left:none;border-right:none;border-top:none;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--white);}

/* TABLE */
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:center;}
.filters input,.filters select{background:var(--gray);border:1px solid var(--border);color:var(--white);padding:9px 14px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;}
.filters input:focus,.filters select:focus{border-color:var(--accent);}
.filters select option{background:var(--black);}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;padding:10px 14px;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:11px 14px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
.trow{cursor:pointer;}
.trow:hover td{background:rgba(200,168,75,0.05);}
.avatar{width:30px;height:30px;background:var(--accent);color:var(--black);display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}

/* BADGES */
.cat-badge{padding:4px 10px;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;background:var(--gray2);color:var(--accent);white-space:nowrap;display:inline-block;margin:2px 2px 2px 0;}
.status-badge{padding:4px 10px;font-size:10px;letter-spacing:1px;text-transform:uppercase;display:inline-flex;}
.s-pending{background:rgba(200,168,75,0.15);color:var(--accent);}
.s-approved{background:rgba(76,175,125,0.15);color:var(--success);}
.s-rejected{background:rgba(224,85,85,0.15);color:var(--danger);}

/* ACTION BTNS */
.act-btn{padding:5px 10px;font-size:10px;letter-spacing:1px;text-transform:uppercase;font-weight:600;cursor:pointer;border:1px solid;background:transparent;transition:all .2s;font-family:'DM Sans',sans-serif;white-space:nowrap;}
.act-approve{border-color:var(--success);color:var(--success);}
.act-approve:hover{background:var(--success);color:var(--black);}
.act-reject{border-color:var(--danger);color:var(--danger);}
.act-reject:hover{background:var(--danger);color:#fff;}
.act-delete{border-color:#555;color:#555;}
.act-delete:hover{background:#555;color:#fff;}

/* EXPENSE ITEM (trader) */
.exp-list{display:flex;flex-direction:column;gap:10px;}
.exp-item{background:var(--black);border:1px solid var(--border);padding:16px 20px;display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:14px;cursor:pointer;transition:border-color .2s;}
.exp-item:hover{border-color:rgba(200,168,75,0.4);}
.exp-amount{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent2);white-space:nowrap;}
.exp-date{font-size:11px;color:var(--dim);text-align:right;white-space:nowrap;}

/* EXPENSE LINES (form) */
.exp-line{background:var(--black);border:1px solid var(--border);padding:16px;margin-bottom:10px;}
.exp-line-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.exp-line-num{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;color:var(--accent);}
.remove-line{background:none;border:none;color:var(--danger);cursor:pointer;font-size:18px;padding:2px 6px;line-height:1;}
.line-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
@media(max-width:600px){.line-grid{grid-template-columns:1fr 1fr;}}

/* BIZ STATS */
.biz-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px;}
.biz-label{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:3px;color:var(--dim);}
.biz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;margin-bottom:24px;}
.biz-card{background:var(--black);border:1px solid var(--border);padding:16px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.biz-bar{width:4px;height:34px;flex-shrink:0;}
.biz-name{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;}
.biz-count{font-size:10px;color:var(--dim);}
.biz-amounts{display:flex;gap:16px;flex-wrap:wrap;}
.biz-amt-label{font-size:10px;color:var(--dim);margin-bottom:2px;}
.biz-amt-val{font-family:'Bebas Neue',sans-serif;font-size:16px;}

/* USERS */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px;}
.user-card{background:var(--black);border:1px solid var(--border);padding:18px;display:flex;align-items:center;gap:12px;}
.user-av{width:42px;height:42px;background:var(--accent);color:var(--black);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0;}
.user-biz{font-size:11px;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}

/* CATS */
.cat-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.cat-tag{display:flex;align-items:center;gap:6px;background:var(--gray2);border:1px solid var(--border);padding:6px 12px;font-size:12px;}
.cat-tag button{background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px;line-height:1;}

/* UPLOAD */
.upload-area{border:2px dashed var(--border);padding:24px;text-align:center;cursor:pointer;transition:border-color .2s;position:relative;background:var(--black);}
.upload-area:hover{border-color:var(--accent);}
.upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;}
.upload-text{font-size:13px;color:var(--dim);}
.upload-text span{color:var(--accent);font-weight:600;}
.prev-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
.prev-wrap{position:relative;}
.prev-img{width:72px;height:72px;object-fit:cover;border:1px solid var(--border);cursor:pointer;display:block;}
.prev-rm{position:absolute;top:-6px;right:-6px;width:18px;height:18px;background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:800;align-items:center;justify-content:center;padding:16px;}
.overlay.open{display:flex;}
.modal{background:var(--gray);border:1px solid var(--border);padding:32px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .2s ease;}
.modal-wide{max-width:700px;}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;margin-bottom:20px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;flex-wrap:wrap;}

/* DETAIL PAGE (full screen overlay) */
#detailPage{display:none;position:fixed;inset:0;background:var(--black);z-index:600;overflow-y:auto;}
.dp-header{background:var(--gray);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.dp-back{display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--accent);font-size:13px;font-weight:600;letter-spacing:1px;text-transform:uppercase;background:none;border:none;}
.dp-back:hover{color:var(--accent2);}
.dp-content{max-width:860px;margin:0 auto;padding:32px 24px;}
.dp-title{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:2px;margin-bottom:4px;}
.dp-sub{font-size:13px;color:var(--dim);margin-bottom:24px;}
.dp-section{background:var(--gray);border:1px solid var(--border);padding:22px;margin-bottom:16px;}
.dp-section-title{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:3px;color:var(--dim);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.dp-meta{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;}
.dp-meta-item label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);display:block;margin-bottom:4px;}
.dp-meta-item span{font-size:14px;font-weight:500;}
.dp-line{background:var(--black);border:1px solid var(--border);padding:12px 16px;margin-bottom:8px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.dp-line-num{font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:2px;color:var(--dim);min-width:48px;}
.dp-line-amt{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent2);}
.dp-line-desc{font-size:12px;color:var(--dim);flex:1;}
.dp-imgs{display:flex;flex-wrap:wrap;gap:10px;}
.dp-img{width:90px;height:90px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.dp-img:hover{border-color:var(--accent);transform:scale(1.05);}
.dp-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;}

/* LIGHTBOX */
#lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center;}
#lightbox.open{display:flex;}
#lightbox img{max-width:90vw;max-height:88vh;object-fit:contain;}
.lb-close{position:fixed;top:16px;right:20px;font-size:28px;color:#fff;cursor:pointer;background:none;border:none;}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;background:var(--gray);border-left:3px solid var(--success);padding:14px 20px;font-size:13px;z-index:9999;max-width:320px;display:none;}
#toast.err{border-left-color:var(--danger);}

/* SPINNER */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--dim);}
.empty .big{font-family:'Bebas Neue',sans-serif;font-size:48px;color:rgba(255,255,255,0.05);}

/* FORM GRID */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-grid .full{grid-column:1/-1;}
@media(max-width:600px){.form-grid{grid-template-columns:1fr;}}

@media(max-width:700px){
  main{padding:18px 12px;}
  .card{padding:18px;}
  .h-brand{display:none;}
  .stats-row{grid-template-columns:1fr 1fr;}
  .exp-item{grid-template-columns:1fr 1fr;}
}
</style>
</head>
<body>

<div id="loader"><div class="loader-logo">IB</div><div class="loader-text">Conectando ao sistema...</div></div>

<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-mark"><span>IB</span></div>
      <div class="login-logo-text">
        <strong>INDEPENDENT BRAZIL</strong>
        <small>ComÃ©rcio Exterior</small>
      </div>
    </div>
    <div class="login-title">Acesso ao Sistema</div>
    <p class="login-sub">PrestaÃ§Ã£o de Contas Â· Colaboradores & Financeiro</p>
    <div class="field"><label>E-mail</label><input type="email" id="lEmail" placeholder="seu@email.com"></div>
    <div class="field"><label>Senha</label><input type="password" id="lPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <div id="lError" class="error-msg"></div>
    <div style="margin-top:24px;"><button class="btn btn-primary btn-full" id="lBtn">Entrar</button></div>
  </div>
</div>

<div id="app">
  <header>
    <div class="h-left">
      <div class="h-logo"><span>IB</span></div>
      <div><div class="h-brand">INDEPENDENT BRAZIL</div><div class="h-role" id="hRole"></div></div>
    </div>
    <div class="h-right">
      <div class="user-pill" id="hUser"></div>
      <button class="btn btn-outline" style="padding:8px 14px;font-size:11px;" id="logoutBtn">Sair</button>
    </div>
  </header>
  <main id="mainContent"></main>
</div>

<!-- DETAIL PAGE -->
<div id="detailPage">
  <div class="dp-header">
    <button class="dp-back" id="dpBackBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Voltar
    </button>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;color:var(--dim);">INDEPENDENT BRAZIL</div>
    <div id="dpHeaderActions" style="display:flex;gap:8px;"></div>
  </div>
  <div class="dp-content" id="dpContent"></div>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="mTitle"></div>
    <div id="mBody"></div>
    <div class="modal-actions" id="mActions"></div>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox">
  <button class="lb-close" id="lbClose">&#x2715;</button>
  <img id="lbImg" src="" alt="">
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BIZ = ['Import','Feed Meal','Meat','Commodities','Seafood','Gerencia','Financeiro','Operacional','Analista Comercial'];
const BIZ_COLOR = {'Import':'#4a9eff','Feed Meal':'#c8a84b','Meat':'#e05555','Commodities':'#4caf7d','Seafood':'#a78bfa','Gerencia':'#f97316','Financeiro':'#06b6d4','Operacional':'#84cc16','Analista Comercial':'#ec4899'};
const SYM = {BRL:'R$',USD:'US$',EUR:'â‚¬'};
const S_LABEL = {pending:'Pendente',approved:'Aprovado',rejected:'Recusado'};
const S_CLASS = {pending:'s-pending',approved:'s-approved',rejected:'s-rejected'};

let CU = null; // current user
let allExp = [];
let cats = ['Viagem','Aluguel de Carro','AlimentaÃ§Ã£o','Brinde','Outros'];
let expLines = [{id: Date.now()}];
let pendingImgs = [];
let adminTab = 'expenses';
let filteredExp = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const db = () => window._db;
const fb = () => window._fb;

async function getAll(col) {
  const {collection,getDocs,query,orderBy} = fb();
  const snap = await getDocs(query(collection(db(),col),orderBy('createdAt','desc')));
  return snap.docs.map(d=>d.data());
}
async function getOne(col,id) {
  const {doc,getDoc} = fb();
  const snap = await getDoc(doc(db(),col,id));
  return snap.exists() ? snap.data() : null;
}
async function setOne(col,id,data) {
  const {doc,setDoc} = fb();
  await setDoc(doc(db(),col,id),data);
}
async function updateOne(col,id,data) {
  const {doc,updateDoc} = fb();
  await updateDoc(doc(db(),col,id),data);
}
async function delOne(col,id) {
  const {doc,deleteDoc} = fb();
  await deleteDoc(doc(db(),col,id));
}
async function loadCats() {
  const cfg = await getOne('config','categories');
  if (cfg && cfg.list) cats = cfg.list;
}
async function saveCats() { await setOne('config','categories',{list:cats}); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SS = { save: u => { try{sessionStorage.setItem('ib',JSON.stringify(u));}catch(e){} }, load: () => { try{const s=sessionStorage.getItem('ib');return s?JSON.parse(s):null;}catch(e){return null;} }, clear: () => { try{sessionStorage.removeItem('ib');}catch(e){} } };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  emailjs.init({publicKey:'9A4MxQWrnZ3cwvxAg'});
});

document.addEventListener('firebaseReady', async () => {
  await loadCats();
  const saved = SS.load();
  if (saved) {
    try {
      const users = await getAll('users');
      const u = users.find(x => x.id === saved.id);
      if (u) { loginUser(u); return; }
    } catch(e) {}
  }
  document.getElementById('loader').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
});

setTimeout(() => {
  if (!window._firebaseReady) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
  }
}, 6000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('lBtn').onclick = doLogin;
document.getElementById('logoutBtn').onclick = logout;
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') doLogin();
});

async function doLogin() {
  const email = document.getElementById('lEmail').value.trim();
  const pass = document.getElementById('lPass').value;
  const btn = document.getElementById('lBtn');
  btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
  try {
    const users = await getAll('users');
    const u = users.find(x => x.email === email && x.password === pass);
    if (!u) { document.getElementById('lError').textContent = 'E-mail ou senha incorretos.'; btn.innerHTML='Entrar'; btn.disabled=false; return; }
    loginUser(u);
  } catch(e) { document.getElementById('lError').textContent = 'Erro de conexÃ£o.'; }
  btn.innerHTML = 'Entrar'; btn.disabled = false;
}

function loginUser(u) {
  CU = u; SS.save(u);
  document.getElementById('loader').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('hUser').textContent = u.name;
  document.getElementById('hRole').textContent = u.role === 'admin' ? 'Financeiro Â· Admin' : `${u.businessLine||''}`;
  if (u.role === 'admin') renderAdmin(); else renderTrader();
}

function logout() {
  CU = null; SS.clear(); pendingImgs = []; expLines = [{id:Date.now()}];
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('lEmail').value = ''; document.getElementById('lPass').value = '';
  document.getElementById('lError').textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTrader() {
  document.getElementById('mainContent').innerHTML = '<div style="text-align:center;padding:60px;"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>';
  const all = await getAll('expenses');
  const mine = all.filter(e => e.userId === CU.id);
  allExp = mine;

  const html = `
    <div class="page-title">OlÃ¡, ${CU.name.split(' ')[0]}</div>
    <div class="page-sub">PrestaÃ§Ã£o de contas Â· ${CU.businessLine||''}</div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total enviado</div><div class="stat-value">${mine.length}</div><div class="stat-sub">prestaÃ§Ãµes</div></div>
      <div class="stat-card"><div class="stat-label">Pendentes</div><div class="stat-value">${mine.filter(e=>e.status==='pending').length}</div><div class="stat-sub">aguardando</div></div>
      <div class="stat-card"><div class="stat-label">Aprovadas</div><div class="stat-value">${mine.filter(e=>e.status==='approved').length}</div><div class="stat-sub">aprovadas</div></div>
      <div class="stat-card"><div class="stat-label">Recusadas</div><div class="stat-value">${mine.filter(e=>e.status==='rejected').length}</div><div class="stat-sub">recusadas</div></div>
    </div>
    <div class="card">
      <div class="card-title"><div class="card-title-left"><div class="dot"></div> Nova PrestaÃ§Ã£o</div></div>
      <div class="form-grid">
        <div class="field"><label>Evento *</label><input type="text" id="fEvento" placeholder="Ex: ReuniÃ£o Porto / Fenavem 2024"></div>
        <div class="field"><label>Data *</label><input type="date" id="fData"></div>
        <div class="field full"><label>DescriÃ§Ã£o Geral</label><input type="text" id="fDesc" placeholder="Detalhes adicionais..."></div>
      </div>
      <div style="margin:18px 0 8px;font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;color:var(--accent);">LINHAS DE DESPESA</div>
      <div id="linesContainer"></div>
      <button class="btn btn-outline" style="padding:8px 16px;font-size:11px;margin-top:6px;" id="addLineBtn">+ Adicionar linha</button>
      <div style="margin-top:18px;">
        <label class="field" style="margin-bottom:0">
          <label>Comprovantes / Imagens</label>
          <div class="upload-area">
            <input type="file" id="fImgs" accept="image/*" multiple>
            <div class="upload-text"><span>Clique ou arraste</span> para adicionar imagens<br><small>JPG, PNG, WEBP Â· mÃºltiplos arquivos</small></div>
          </div>
          <div class="prev-grid" id="prevGrid"></div>
        </label>
      </div>
      <div style="margin-top:20px;"><button class="btn btn-gold" id="submitBtn">Enviar PrestaÃ§Ã£o</button></div>
    </div>
    <div class="card">
      <div class="card-title"><div class="card-title-left"><div class="dot"></div> Minhas PrestaÃ§Ãµes</div><span style="font-size:11px;color:var(--dim);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;">Clique para ver detalhes</span></div>
      ${mine.length===0 ? '<div class="empty"><div class="big">IB</div><p>Nenhuma prestaÃ§Ã£o enviada ainda.</p></div>'
      : `<div class="exp-list" id="expList">${mine.map(expCard).join('')}</div>`}
    </div>`;
  document.getElementById('mainContent').innerHTML = html;

  // Set date
  document.getElementById('fData').valueAsDate = new Date();

  // Render lines
  expLines = [{id: Date.now()}];
  renderLines();

  // Events
  document.getElementById('addLineBtn').onclick = addLine;
  document.getElementById('fImgs').onchange = handleImgUpload;
  document.getElementById('submitBtn').onclick = submitExp;

  // Expense item clicks
  if (document.getElementById('expList')) {
    document.getElementById('expList').addEventListener('click', e => {
      const item = e.target.closest('.exp-item[data-id]');
      if (item) openDetail(item.dataset.id);
    });
  }
}

function expCard(e) {
  const first = e.lines && e.lines.length ? e.lines[0] : null;
  return `<div class="exp-item" data-id="${e.id}">
    <span class="cat-badge">${first ? first.category : (e.category||'â€”')}</span>
    <div>
      <strong style="font-size:14px;">${e.event}</strong>
      <div style="font-size:12px;color:var(--dim);margin-top:2px;">${e.description||'â€”'}</div>
      ${e.lines && e.lines.length > 1 ? `<div style="font-size:11px;color:var(--accent);margin-top:4px;">${e.lines.length} linhas de despesa</div>` : ''}
    </div>
    <div style="text-align:right;">
      <div class="exp-amount">${first ? SYM[first.currency]+' '+fmt(first.amount) : ''}</div>
      <span class="status-badge ${S_CLASS[e.status]}">${S_LABEL[e.status]}</span>
    </div>
    <div class="exp-date">${fmtDate(e.date)}<br><span style="color:#444;font-size:10px;">incl. ${fmtDT(e.createdAt)}</span></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSE LINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lineHTML(id, num, showRemove) {
  return `<div class="exp-line" id="el_${id}">
    <div class="exp-line-header">
      <span class="exp-line-num">LINHA ${num}</span>
      ${showRemove ? `<button class="remove-line" data-lid="${id}">âœ•</button>` : ''}
    </div>
    <div class="line-grid">
      <div class="field" style="margin:0"><label>Categoria *</label>
        <select id="lc_${id}">
          <option value="">â€” Selecione â€”</option>
          ${cats.map(c=>`<option>${c}</option>`).join('')}
        </select>
      </div>
      <div class="field" style="margin:0"><label>Valor *</label><input type="number" id="lv_${id}" placeholder="0,00" step="0.01" min="0"></div>
      <div class="field" style="margin:0"><label>Moeda</label>
        <select id="lm_${id}"><option value="BRL">R$ Real</option><option value="USD">$ USD</option><option value="EUR">â‚¬ Euro</option></select>
      </div>
      <div class="field" style="margin:0;grid-column:1/-1"><label>DescriÃ§Ã£o</label><input type="text" id="ld_${id}" placeholder="DescriÃ§Ã£o desta despesa..."></div>
    </div>
  </div>`;
}

function renderLines() {
  const c = document.getElementById('linesContainer');
  if (!c) return;
  c.innerHTML = expLines.map((l,i) => lineHTML(l.id, i+1, expLines.length > 1)).join('');
  c.addEventListener('click', e => {
    const btn = e.target.closest('.remove-line');
    if (btn) removeLine(parseInt(btn.dataset.lid));
  });
}

function addLine() {
  const c = document.getElementById('linesContainer');
  if (!c) return;
  const newId = Date.now();
  expLines.push({id: newId});
  // Only append new line, don't re-render existing
  const div = document.createElement('div');
  div.innerHTML = lineHTML(newId, expLines.length, true);
  c.appendChild(div.firstElementChild);
  // Update "remove" visibility on first line if now >1
  if (expLines.length === 2) {
    const firstLine = c.querySelector('.exp-line');
    if (firstLine && !firstLine.querySelector('.remove-line')) {
      const header = firstLine.querySelector('.exp-line-header');
      const btn = document.createElement('button');
      btn.className = 'remove-line'; btn.dataset.lid = expLines[0].id; btn.textContent = 'âœ•';
      header.appendChild(btn);
    }
  }
}

function removeLine(id) {
  expLines = expLines.filter(l => l.id !== id);
  const el = document.getElementById('el_'+id);
  if (el) el.remove();
  // Update numbers
  document.querySelectorAll('.exp-line-num').forEach((el,i) => el.textContent = `LINHA ${i+1}`);
  // Hide remove on last remaining
  if (expLines.length === 1) {
    const rmBtn = document.querySelector('.remove-line');
    if (rmBtn) rmBtn.remove();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleImgUpload(e) {
  Array.from(e.target.files).forEach(file => {
    const r = new FileReader();
    r.onload = ev => { pendingImgs.push({name:file.name,dataUrl:ev.target.result}); renderPrevs(); };
    r.readAsDataURL(file);
  });
  e.target.value = '';
}
function renderPrevs() {
  const g = document.getElementById('prevGrid');
  if (!g) return;
  g.innerHTML = pendingImgs.map((img,i) => `
    <div class="prev-wrap">
      <img class="prev-img" src="${img.dataUrl}" data-src="${img.dataUrl}">
      <button class="prev-rm" data-idx="${i}">âœ•</button>
    </div>`).join('');
  g.querySelectorAll('.prev-img').forEach(img => img.onclick = () => openLB(img.dataset.src));
  g.querySelectorAll('.prev-rm').forEach(btn => btn.onclick = () => { pendingImgs.splice(parseInt(btn.dataset.idx),1); renderPrevs(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitExp() {
  const evento = document.getElementById('fEvento').value.trim();
  const data = document.getElementById('fData').value;
  const desc = document.getElementById('fDesc').value.trim();
  if (!evento || !data) { toast('Preencha evento e data.', true); return; }

  const lines = [];
  for (const l of expLines) {
    const cat = document.getElementById('lc_'+l.id)?.value;
    const val = parseFloat(document.getElementById('lv_'+l.id)?.value);
    const moeda = document.getElementById('lm_'+l.id)?.value || 'BRL';
    const ld = document.getElementById('ld_'+l.id)?.value.trim();
    if (!cat || isNaN(val) || val <= 0) { toast('Preencha categoria e valor em todas as linhas.', true); return; }
    lines.push({category:cat, amount:val, currency:moeda, description:ld||''});
  }

  const btn = document.getElementById('submitBtn');
  btn.innerHTML = '<span class="spinner"></span> Enviando...'; btn.disabled = true;

  try {
    const id = 'exp_'+Date.now();
    const exp = {
      id, userId:CU.id, userName:CU.name, businessLine:CU.businessLine||'',
      event:evento, date:data, description:desc, lines,
      category:lines[0].category, amount:lines[0].amount, currency:lines[0].currency,
      images:pendingImgs.map(i=>({name:i.name,dataUrl:i.dataUrl})),
      status:'pending', createdAt:new Date().toISOString()
    };
    await setOne('expenses', id, exp);
    await sendEmail(exp);
    pendingImgs = []; expLines = [{id:Date.now()}];
    toast('PrestaÃ§Ã£o enviada com sucesso! âœ“');
    renderTrader();
  } catch(e) { toast('Erro ao enviar.', true); console.error(e); }
  btn.innerHTML = 'Enviar PrestaÃ§Ã£o'; btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendEmail(exp, isRejection = false) {
  try {
    const linesText = exp.lines.map((l,i)=>`Linha ${i+1}: ${l.category} | ${SYM[l.currency]} ${fmt(l.amount)} | ${l.description||'â€”'}`).join('\n');
    const subject = isRejection ? `PrestaÃ§Ã£o RECUSADA: ${exp.event}` : `Nova PrestaÃ§Ã£o: ${exp.event}`;
    const msg = isRejection
      ? `OlÃ¡ ${exp.userName},\n\nSua prestaÃ§Ã£o foi RECUSADA pelo financeiro.\n\nEvento: ${exp.event}\nData: ${fmtDate(exp.date)}\n\n${linesText}\n\nIndependent Brazil`
      : `Trader: ${exp.userName}\nLinha: ${exp.businessLine}\nEvento: ${exp.event}\nData: ${fmtDate(exp.date)}\nDescriÃ§Ã£o: ${exp.description||'â€”'}\n\n${linesText}\n\nImagens: ${exp.images?exp.images.length:0}`;
    await emailjs.send('service_7ojw3be','template_5r3es1d',{
      trader_name:exp.userName, business_line:exp.businessLine||'â€”',
      event:exp.event, category:exp.lines.map(l=>l.category).join(', '),
      date:fmtDate(exp.date),
      amount:exp.lines.map(l=>`${SYM[l.currency]} ${fmt(l.amount)}`).join(' | '),
      description:exp.description||'â€”', created_at:new Date(exp.createdAt).toLocaleString('pt-BR'),
      image_count:exp.images?exp.images.length:0,
      name:exp.userName, title:subject, message:msg
    });
  } catch(e) { console.warn('Email error:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openDetail(id) {
  let exp = allExp.find(e => e.id === id);
  if (!exp) { try { exp = await getOne('expenses', id); } catch(e){} }
  if (!exp) { toast('PrestaÃ§Ã£o nÃ£o encontrada.', true); return; }

  const isAdmin = CU.role === 'admin';
  const color = BIZ_COLOR[exp.businessLine]||'var(--white)';

  const linesHtml = (exp.lines || [{category:exp.category,amount:exp.amount,currency:exp.currency,description:''}]).map((l,i) => `
    <div class="dp-line">
      <span class="dp-line-num">LINHA ${i+1}</span>
      <span class="cat-badge">${l.category}</span>
      <span class="dp-line-amt">${SYM[l.currency]} ${fmt(l.amount)}</span>
      ${l.description ? `<span class="dp-line-desc">${l.description}</span>` : ''}
    </div>`).join('');

  const imgsHtml = exp.images && exp.images.length
    ? exp.images.map(img=>`<img class="dp-img" src="${img.dataUrl}" data-src="${img.dataUrl}">`).join('')
    : '<span style="color:var(--dim);font-size:13px;">Nenhuma imagem anexada</span>';

  // Header actions
  let headerActions = '';
  if (isAdmin && exp.status === 'pending') {
    headerActions = `
      <button class="btn btn-gold" style="padding:8px 16px;font-size:11px;" data-action="approve" data-id="${exp.id}">âœ“ Aprovar</button>
      <button class="btn btn-outline" style="padding:8px 16px;font-size:11px;border-color:var(--danger);color:var(--danger);" data-action="reject" data-id="${exp.id}">âœ• Recusar</button>`;
  } else if (isAdmin && exp.status === 'rejected') {
    headerActions = `<button class="btn btn-danger" style="padding:8px 16px;font-size:11px;" data-action="delete" data-id="${exp.id}">ğŸ—‘ Excluir</button>`;
  }

  document.getElementById('dpHeaderActions').innerHTML = headerActions;
  document.getElementById('dpContent').innerHTML = `
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:6px;flex-wrap:wrap;">
      <div class="dp-title">${exp.event}</div>
      <span class="status-badge ${S_CLASS[exp.status]}">${S_LABEL[exp.status]}</span>
    </div>
    <div class="dp-sub">IncluÃ­do em ${new Date(exp.createdAt).toLocaleString('pt-BR')}</div>

    <div class="dp-section">
      <div class="dp-section-title">INFORMAÃ‡Ã•ES GERAIS</div>
      <div class="dp-meta">
        <div class="dp-meta-item"><label>UsuÃ¡rio</label><span>${exp.userName}</span></div>
        <div class="dp-meta-item"><label>Linha de NegÃ³cio</label><span style="color:${color};font-weight:600;">${exp.businessLine||'â€”'}</span></div>
        <div class="dp-meta-item"><label>Data da Despesa</label><span>${fmtDate(exp.date)}</span></div>
        <div class="dp-meta-item"><label>Qtd de Linhas</label><span>${exp.lines ? exp.lines.length : 1}</span></div>
        ${exp.description ? `<div class="dp-meta-item" style="grid-column:1/-1"><label>DescriÃ§Ã£o Geral</label><span>${exp.description}</span></div>` : ''}
      </div>
    </div>

    <div class="dp-section">
      <div class="dp-section-title">LINHAS DE DESPESA</div>
      ${linesHtml}
    </div>

    <div class="dp-section">
      <div class="dp-section-title">COMPROVANTES (${exp.images?exp.images.length:0})</div>
      <div class="dp-imgs">${imgsHtml}</div>
    </div>

    ${isAdmin && exp.status === 'pending' ? `
    <div class="dp-actions">
      <button class="btn btn-gold" data-action="approve" data-id="${exp.id}">âœ“ Aprovar PrestaÃ§Ã£o</button>
      <button class="btn btn-outline" style="border-color:var(--danger);color:var(--danger);" data-action="reject" data-id="${exp.id}">âœ• Recusar PrestaÃ§Ã£o</button>
    </div>` : ''}
    ${isAdmin && exp.status === 'rejected' ? `
    <div class="dp-actions">
      <button class="btn btn-danger" data-action="delete" data-id="${exp.id}">ğŸ—‘ Excluir PrestaÃ§Ã£o</button>
    </div>` : ''}
  `;

  const dp = document.getElementById('detailPage');
  dp.style.display = 'block';
  dp.scrollTop = 0;

  // Image clicks
  document.querySelectorAll('.dp-img').forEach(img => img.onclick = () => openLB(img.dataset.src));

  // Action buttons (both header and bottom)
  document.querySelectorAll('[data-action]').forEach(btn => {
    btn.onclick = () => {
      const action = btn.dataset.action;
      const eid = btn.dataset.id;
      if (action === 'approve') { changeStatus(eid, 'approved'); closeDetail(); }
      else if (action === 'reject') { changeStatus(eid, 'rejected'); closeDetail(); }
      else if (action === 'delete') { deleteExp(eid); }
    };
  });
}

function closeDetail() {
  document.getElementById('detailPage').style.display = 'none';
}

document.getElementById('dpBackBtn').onclick = closeDetail;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAdmin() {
  document.getElementById('mainContent').innerHTML = '<div style="text-align:center;padding:60px;"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>';
  allExp = await getAll('expenses');
  renderAdminHTML();
}

function renderAdminHTML() {
  const approved = allExp.filter(e => e.status === 'approved');
  const getTotal = (exps, cur) => exps.reduce((s,e) => {
    if (e.lines) return s + e.lines.filter(l=>l.currency===cur).reduce((a,l)=>a+l.amount,0);
    return e.currency===cur ? s+e.amount : s;
  }, 0);

  const html = `
    <div class="page-title">Painel Financeiro</div>
    <div class="page-sub">Independent Brazil Â· apenas aprovadas sÃ£o contabilizadas</div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total BRL (aprovado)</div><div class="stat-value">R$ ${fmt(getTotal(approved,'BRL'))}</div><div class="stat-sub">${approved.length} aprovadas</div></div>
      <div class="stat-card"><div class="stat-label">Total USD (aprovado)</div><div class="stat-value">$ ${fmt(getTotal(approved,'USD'))}</div></div>
      <div class="stat-card"><div class="stat-label">Total EUR (aprovado)</div><div class="stat-value">â‚¬ ${fmt(getTotal(approved,'EUR'))}</div></div>
      <div class="stat-card"><div class="stat-label">Pendentes</div><div class="stat-value">${allExp.filter(e=>e.status==='pending').length}</div><div class="stat-sub">aguardando revisÃ£o</div></div>
    </div>

    <div class="biz-header">
      <div class="biz-label">TOTAL POR LINHA DE NEGÃ“CIO (APROVADAS)</div>
      <button class="btn btn-gold" style="padding:9px 18px;font-size:11px;" id="reportBtn">ğŸ“Š Gerar RelatÃ³rio PDF</button>
    </div>
    <div class="biz-grid">${BIZ.map(line => {
      const exps = approved.filter(e=>e.businessLine===line);
      const brl = getTotal(exps,'BRL'), usd = getTotal(exps,'USD'), eur = getTotal(exps,'EUR');
      const c = BIZ_COLOR[line]||'#888';
      return `<div class="biz-card">
        <div class="biz-bar" style="background:${c};"></div>
        <div><div class="biz-name" style="color:${c};">${line}</div><div class="biz-count">${exps.length} prestaÃ§Ã£o(Ãµes)</div></div>
        <div class="biz-amounts">
          <div><div class="biz-amt-label">BRL</div><div class="biz-amt-val">R$ ${fmt(brl)}</div></div>
          <div><div class="biz-amt-label">USD</div><div class="biz-amt-val">$ ${fmt(usd)}</div></div>
          <div><div class="biz-amt-label">EUR</div><div class="biz-amt-val">â‚¬ ${fmt(eur)}</div></div>
        </div>
      </div>`;
    }).join('')}</div>

    <div class="tabs">
      <button class="tab ${adminTab==='expenses'?'active':''}" data-tab="expenses">PrestaÃ§Ãµes</button>
      <button class="tab ${adminTab==='users'?'active':''}" data-tab="users">UsuÃ¡rios</button>
      <button class="tab ${adminTab==='categories'?'active':''}" data-tab="categories">Categorias</button>
    </div>
    <div id="tabContent"></div>`;

  document.getElementById('mainContent').innerHTML = html;

  document.getElementById('reportBtn').onclick = openReportModal;

  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      adminTab = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderTab();
    };
  });

  renderTab();
}

function renderTab() {
  if (adminTab === 'expenses') renderExpTab();
  else if (adminTab === 'users') renderUsersTab();
  else renderCatsTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSES TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExpTab() {
  document.getElementById('tabContent').innerHTML = `
    <div class="card">
      <div class="card-title">
        <div class="card-title-left"><div class="dot"></div> Todas as PrestaÃ§Ãµes</div>
        <span style="font-size:11px;color:var(--dim);font-family:'DM Sans',sans-serif;font-weight:400;letter-spacing:0;">Clique em qualquer linha para ver detalhes</span>
      </div>
      <div class="filters">
        <input type="text" id="fTxt" placeholder="Buscar trader, evento..." style="min-width:180px;">
        <select id="fBiz"><option value="">Todas as linhas</option>${BIZ.map(l=>`<option>${l}</option>`).join('')}</select>
        <select id="fCat"><option value="">Todas categorias</option>${cats.map(c=>`<option>${c}</option>`).join('')}</select>
        <select id="fSt"><option value="">Todos status</option><option value="pending">Pendente</option><option value="approved">Aprovado</option><option value="rejected">Recusado</option></select>
        <div style="display:flex;gap:8px;margin-left:auto;">
          <button class="btn btn-outline" style="padding:9px 16px;font-size:11px;" id="xlsBtn">â¬‡ Excel</button>
          <button class="btn btn-outline" style="padding:9px 16px;font-size:11px;" id="pdfBtn">â¬‡ PDF</button>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Trader</th><th>Linha</th><th>Evento</th><th>Categoria(s)</th><th>Data</th><th>Valor(es)</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
        <tbody id="expTbody"></tbody>
      </table></div>
    </div>`;

  document.getElementById('fTxt').oninput = buildTable;
  document.getElementById('fBiz').onchange = buildTable;
  document.getElementById('fCat').onchange = buildTable;
  document.getElementById('fSt').onchange = buildTable;
  document.getElementById('xlsBtn').onclick = exportXLS;
  document.getElementById('pdfBtn').onclick = exportPDF;

  buildTable();

  // Row click delegation
  document.getElementById('expTbody').addEventListener('click', e => {
    if (e.target.closest('button')) return;
    const tr = e.target.closest('tr[data-id]');
    if (tr) openDetail(tr.dataset.id);
  });
}

function buildTable() {
  const txt = (document.getElementById('fTxt')?.value||'').toLowerCase();
  const biz = document.getElementById('fBiz')?.value||'';
  const cat = document.getElementById('fCat')?.value||'';
  const st = document.getElementById('fSt')?.value||'';

  filteredExp = allExp.filter(e => {
    const catStr = e.lines ? e.lines.map(l=>l.category).join(' ') : (e.category||'');
    return (!txt || e.userName.toLowerCase().includes(txt) || e.event.toLowerCase().includes(txt))
        && (!biz || e.businessLine===biz)
        && (!cat || catStr.includes(cat))
        && (!st || e.status===st);
  });

  const tbody = document.getElementById('expTbody');
  if (!tbody) return;
  if (!filteredExp.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--dim);padding:40px;">Nenhuma prestaÃ§Ã£o encontrada.</td></tr>`;
    return;
  }
  tbody.innerHTML = filteredExp.map(e => {
    const color = BIZ_COLOR[e.businessLine]||'var(--dim)';
    const ini = e.userName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
    const catsHtml = (e.lines ? [...new Set(e.lines.map(l=>l.category))] : [e.category||'â€”']).map(c=>`<span class="cat-badge">${c}</span>`).join('');
    const amts = e.lines ? e.lines.map(l=>`${SYM[l.currency]} ${fmt(l.amount)}`).join('<br>') : `${SYM[e.currency]||''} ${fmt(e.amount||0)}`;
    const actionBtns = e.status==='pending'
      ? `<div style="display:flex;gap:5px;"><button class="act-btn act-approve" data-action="approve" data-id="${e.id}">âœ“ Aprovar</button><button class="act-btn act-reject" data-action="reject" data-id="${e.id}">âœ• Recusar</button></div>`
      : e.status==='rejected'
      ? `<button class="act-btn act-delete" data-action="delete" data-id="${e.id}">Excluir</button>`
      : `<span style="color:var(--dim);font-size:11px;">â€”</span>`;
    return `<tr class="trow" data-id="${e.id}">
      <td><div style="display:flex;align-items:center;gap:8px;"><div class="avatar">${ini}</div>${e.userName}</div></td>
      <td><span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:${color};">${e.businessLine||'â€”'}</span></td>
      <td><strong>${e.event}</strong>${e.description?`<br><small style="color:var(--dim)">${e.description}</small>`:''}</td>
      <td>${catsHtml}</td>
      <td style="color:var(--dim);font-size:12px;">${fmtDate(e.date)}<br><span style="font-size:10px;">incl.${fmtDT(e.createdAt)}</span></td>
      <td style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--accent2);">${amts}</td>
      <td><span class="status-badge ${S_CLASS[e.status]}">${S_LABEL[e.status]}</span></td>
      <td>${actionBtns}</td>
    </tr>`;
  }).join('');

  // Action buttons in table
  tbody.querySelectorAll('[data-action]').forEach(btn => {
    btn.onclick = e => {
      e.stopPropagation();
      const action = btn.dataset.action, id = btn.dataset.id;
      if (action==='approve') changeStatus(id,'approved');
      else if (action==='reject') changeStatus(id,'rejected');
      else if (action==='delete') deleteExp(id);
    };
  });
}

async function changeStatus(id, status) {
  try {
    await updateOne('expenses', id, {status});
    const idx = allExp.findIndex(e=>e.id===id);
    if (idx>=0) allExp[idx].status = status;
    if (status==='rejected') {
      const exp = allExp[idx];
      if (exp) sendEmail(exp, true);
    }
    toast(status==='approved' ? 'PrestaÃ§Ã£o aprovada! âœ“' : 'PrestaÃ§Ã£o recusada.');
    buildTable();
    renderAdminHTML();
  } catch(e) { toast('Erro ao atualizar.', true); }
}

async function deleteExp(id) {
  if (!confirm('Excluir esta prestaÃ§Ã£o permanentemente?')) return;
  try {
    await delOne('expenses', id);
    allExp = allExp.filter(e=>e.id!==id);
    closeDetail();
    toast('PrestaÃ§Ã£o excluÃ­da.');
    buildTable();
    renderAdminHTML();
  } catch(e) { toast('Erro ao excluir.', true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderUsersTab() {
  document.getElementById('tabContent').innerHTML = '<div style="text-align:center;padding:40px;"><span class="spinner" style="width:24px;height:24px;border-width:3px;"></span></div>';
  const all = await getAll('users');
  const traders = all.filter(u=>u.role==='trader');
  document.getElementById('tabContent').innerHTML = `
    <div class="card">
      <div class="card-title"><div class="card-title-left"><div class="dot"></div> UsuÃ¡rios Cadastrados</div></div>
      <div style="margin-bottom:20px;"><button class="btn btn-gold" id="newUserBtn">+ Novo UsuÃ¡rio</button></div>
      ${!traders.length ? '<div class="empty"><div class="big">0</div><p>Nenhum usuÃ¡rio ainda.</p></div>' : `
      <div class="users-grid">${traders.map(u=>`
        <div class="user-card">
          <div class="user-av">${u.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase()}</div>
          <div>
            <strong style="font-size:14px;display:block;">${u.name}</strong>
            <small style="font-size:12px;color:var(--dim);">${u.email}</small>
            <div class="user-biz">${u.businessLine||''}</div>
            <button class="act-btn act-reject" style="margin-top:8px;" data-uid="${u.id}">Remover</button>
          </div>
        </div>`).join('')}
      </div>`}
    </div>`;

  document.getElementById('newUserBtn').onclick = openNewUserModal;
  document.querySelectorAll('[data-uid]').forEach(btn => {
    btn.onclick = () => deleteUser(btn.dataset.uid);
  });
}

function openNewUserModal() {
  document.getElementById('modalBox').classList.remove('modal-wide');
  document.getElementById('mTitle').textContent = 'Cadastrar Novo UsuÃ¡rio';
  document.getElementById('mBody').innerHTML = `
    <div class="field"><label>Nome Completo *</label><input type="text" id="nName" placeholder="JoÃ£o Silva"></div>
    <div class="field"><label>E-mail *</label><input type="email" id="nEmail" placeholder="joao@independentbrazil.com"></div>
    <div class="field"><label>Senha *</label><input type="password" id="nPass" placeholder="MÃ­nimo 4 caracteres"></div>
    <div class="field"><label>Linha de NegÃ³cio *</label>
      <select id="nBiz"><option value="">â€” Selecione â€”</option>${BIZ.map(l=>`<option>${l}</option>`).join('')}</select>
    </div>
    <div id="nErr" class="error-msg"></div>`;
  document.getElementById('mActions').innerHTML = '';
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-outline'; cancelBtn.textContent = 'Cancelar';
  cancelBtn.onclick = closeModal;
  const saveBtn = document.createElement('button');
  saveBtn.className = 'btn btn-gold'; saveBtn.textContent = 'Cadastrar';
  saveBtn.onclick = createUser;
  document.getElementById('mActions').append(cancelBtn, saveBtn);
  openModal();
}

async function createUser() {
  const name = document.getElementById('nName').value.trim();
  const email = document.getElementById('nEmail').value.trim();
  const pass = document.getElementById('nPass').value;
  const biz = document.getElementById('nBiz').value;
  if (!name||!email||pass.length<4||!biz) { document.getElementById('nErr').textContent='Preencha todos os campos (senha mÃ­nimo 4 caracteres).'; return; }
  try {
    const all = await getAll('users');
    if (all.find(u=>u.email===email)) { document.getElementById('nErr').textContent='E-mail jÃ¡ cadastrado.'; return; }
    const id = 'u'+Date.now();
    await setOne('users',id,{id,name,email,password:pass,role:'trader',businessLine:biz,createdAt:new Date().toISOString()});
    closeModal(); toast('UsuÃ¡rio cadastrado! âœ“'); renderUsersTab();
  } catch(e) { toast('Erro ao cadastrar.', true); }
}

async function deleteUser(id) {
  if (!confirm('Remover este usuÃ¡rio?')) return;
  try { await delOne('users',id); toast('UsuÃ¡rio removido.'); renderUsersTab(); }
  catch(e) { toast('Erro ao remover.', true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCatsTab() {
  document.getElementById('tabContent').innerHTML = `
    <div class="card">
      <div class="card-title"><div class="card-title-left"><div class="dot"></div> Gerenciar Categorias</div></div>
      <p style="font-size:13px;color:var(--dim);margin-bottom:18px;">Categorias disponÃ­veis para os usuÃ¡rios ao lanÃ§ar uma prestaÃ§Ã£o.</p>
      <div class="cat-list">${cats.map((c,i)=>`
        <div class="cat-tag"><span>${c}</span><button data-ci="${i}">âœ•</button></div>`).join('')}
      </div>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
        <div class="field" style="margin:0;flex:1;min-width:200px;"><label>Nova Categoria</label><input type="text" id="newCatInp" placeholder="Ex: Hospedagem"></div>
        <button class="btn btn-gold" id="addCatBtn" style="margin-top:20px;">+ Adicionar</button>
      </div>
    </div>`;

  document.querySelectorAll('.cat-tag button').forEach(btn => {
    btn.onclick = () => removeCat(parseInt(btn.dataset.ci));
  });
  document.getElementById('addCatBtn').onclick = addCat;
  document.getElementById('newCatInp').onkeydown = e => { if(e.key==='Enter') addCat(); };
}

async function addCat() {
  const inp = document.getElementById('newCatInp');
  const val = inp?.value.trim();
  if (!val) return;
  if (cats.map(c=>c.toLowerCase()).includes(val.toLowerCase())) { toast('Categoria jÃ¡ existe.', true); return; }
  cats.push(val); await saveCats(); toast('Categoria adicionada! âœ“'); renderCatsTab();
}

async function removeCat(i) {
  if (!confirm(`Remover "${cats[i]}"?`)) return;
  cats.splice(i,1); await saveCats(); toast('Removida.'); renderCatsTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openReportModal() {
  document.getElementById('modalBox').classList.remove('modal-wide');
  document.getElementById('mTitle').textContent = 'Gerar RelatÃ³rio PDF';
  document.getElementById('mBody').innerHTML = `
    <p style="font-size:13px;color:var(--dim);margin-bottom:18px;">Filtre por perÃ­odo para gerar o relatÃ³rio.</p>
    <div class="form-grid">
      <div class="field"><label>Data InÃ­cio</label><input type="date" id="rStart" style="color-scheme:dark;"></div>
      <div class="field"><label>Data Fim</label><input type="date" id="rEnd" style="color-scheme:dark;"></div>
      <div class="field full"><label>Linha de NegÃ³cio</label>
        <select id="rBiz"><option value="">Todas</option>${BIZ.map(l=>`<option>${l}</option>`).join('')}</select>
      </div>
      <div class="field full"><label>Status</label>
        <select id="rSt"><option value="">Todos</option><option value="approved">Aprovadas</option><option value="pending">Pendentes</option><option value="rejected">Recusadas</option></select>
      </div>
    </div>`;
  document.getElementById('mActions').innerHTML = '';
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-outline'; cancelBtn.textContent = 'Cancelar';
  cancelBtn.onclick = closeModal;
  const genBtn = document.createElement('button');
  genBtn.className = 'btn btn-gold'; genBtn.textContent = 'ğŸ“„ Gerar PDF';
  genBtn.onclick = generateReport;
  document.getElementById('mActions').append(cancelBtn, genBtn);
  openModal();

  // Set dates AFTER render
  const today = new Date().toISOString().slice(0,10);
  const first = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10);
  document.getElementById('rStart').value = first;
  document.getElementById('rEnd').value = today;
}

function generateReport() {
  const start = document.getElementById('rStart').value;
  const end = document.getElementById('rEnd').value;
  const biz = document.getElementById('rBiz').value;
  const st = document.getElementById('rSt').value;
  const filtered = allExp.filter(e => (!start||e.date>=start)&&(!end||e.date<=end)&&(!biz||e.businessLine===biz)&&(!st||e.status===st));
  if (!filtered.length) { toast('Nenhuma prestaÃ§Ã£o encontrada.', true); return; }

  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  doc.setFillColor(10,10,10); doc.rect(0,0,297,30,'F');
  doc.setTextColor(245,245,240); doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('INDEPENDENT BRAZIL', 14, 18);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.setTextColor(200,168,75); doc.text('RelatÃ³rio de PrestaÃ§Ãµes de Contas', 14, 25);
  doc.setTextColor(150,150,150);
  doc.text(`PerÃ­odo: ${start?fmtDate(start):'InÃ­cio'} atÃ© ${end?fmtDate(end):'Hoje'} | ${biz||'Todas linhas'} | ${st?S_LABEL[st]:'Todos'} | Gerado: ${new Date().toLocaleString('pt-BR')}`, 14, 29);

  // Summary
  const sumRows = BIZ.filter(l=>!biz||l===biz).map(line => {
    const exps = filtered.filter(e=>e.businessLine===line);
    if (!exps.length) return null;
    const brl = exps.reduce((s,e)=>s+(e.lines?e.lines.filter(l=>l.currency==='BRL').reduce((a,l)=>a+l.amount,0):(e.currency==='BRL'?e.amount:0)),0);
    const usd = exps.reduce((s,e)=>s+(e.lines?e.lines.filter(l=>l.currency==='USD').reduce((a,l)=>a+l.amount,0):(e.currency==='USD'?e.amount:0)),0);
    const eur = exps.reduce((s,e)=>s+(e.lines?e.lines.filter(l=>l.currency==='EUR').reduce((a,l)=>a+l.amount,0):(e.currency==='EUR'?e.amount:0)),0);
    return [line, exps.length+'', `R$ ${fmt(brl)}`, `$ ${fmt(usd)}`, `â‚¬ ${fmt(eur)}`];
  }).filter(Boolean);

  if (sumRows.length) {
    doc.autoTable({head:[['Linha','Qtd','BRL','USD','EUR']],body:sumRows,startY:34,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:[30,30,30],textColor:[200,168,75]},margin:{left:14},tableWidth:'auto'});
  }

  const rows = filtered.map(e => [
    e.userName, e.businessLine||'', e.event,
    e.lines ? e.lines.map(l=>l.category).join(', ') : (e.category||''),
    fmtDate(e.date),
    e.lines ? e.lines.map(l=>`${SYM[l.currency]} ${fmt(l.amount)}`).join(' | ') : `${SYM[e.currency]||''} ${fmt(e.amount||0)}`,
    S_LABEL[e.status]
  ]);
  doc.autoTable({head:[['Trader','Linha','Evento','Categoria(s)','Data','Valor(es)','Status']],body:rows,startY:(doc.lastAutoTable?.finalY||50)+10,styles:{fontSize:7,cellPadding:3},headStyles:{fillColor:[10,10,10],textColor:[200,168,75]},alternateRowStyles:{fillColor:[245,245,240]}});
  doc.save(`IB_Relatorio_${start||'inicio'}_${end||'hoje'}.pdf`);
  closeModal(); toast('RelatÃ³rio gerado! âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportXLS() {
  if (!filteredExp.length) { toast('Nenhum dado para exportar.', true); return; }
  const rows = filteredExp.map(e=>({'Trader':e.userName,'Linha':e.businessLine||'','Evento':e.event,'Data':fmtDate(e.date),'Categoria(s)':e.lines?e.lines.map(l=>l.category).join(', '):(e.category||''),'Valor(es)':e.lines?e.lines.map(l=>`${SYM[l.currency]} ${fmt(l.amount)}`).join(' | '):`${SYM[e.currency]||''} ${fmt(e.amount||0)}`,'DescriÃ§Ã£o':e.description||'','Status':S_LABEL[e.status],'InclusÃ£o':fmtDT(e.createdAt)}));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'PrestaÃ§Ãµes');
  XLSX.writeFile(wb,`IB_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast('Excel exportado! âœ“');
}

function exportPDF() {
  if (!filteredExp.length) { toast('Nenhum dado para exportar.', true); return; }
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  doc.setFillColor(10,10,10); doc.rect(0,0,297,25,'F');
  doc.setTextColor(245,245,240); doc.setFontSize(18); doc.setFont('helvetica','bold');
  doc.text('INDEPENDENT BRAZIL', 14, 16);
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(150,150,150);
  doc.text('PrestaÃ§Ãµes Â· '+new Date().toLocaleDateString('pt-BR'), 14, 22);
  const rows = filteredExp.map(e=>[e.userName,e.businessLine||'',e.event,e.lines?e.lines.map(l=>l.category).join(', '):(e.category||''),fmtDate(e.date),e.lines?e.lines.map(l=>`${SYM[l.currency]} ${fmt(l.amount)}`).join(' | '):`${SYM[e.currency]||''} ${fmt(e.amount||0)}`,S_LABEL[e.status]]);
  doc.autoTable({head:[['Trader','Linha','Evento','Categoria(s)','Data','Valor(es)','Status']],body:rows,startY:30,styles:{fontSize:7,cellPadding:3},headStyles:{fillColor:[10,10,10],textColor:[200,168,75]},alternateRowStyles:{fillColor:[240,240,235]}});
  doc.save(`IB_${new Date().toISOString().slice(0,10)}.pdf`);
  toast('PDF exportado! âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal() { document.getElementById('overlay').classList.add('open'); }
function closeModal() { document.getElementById('overlay').classList.remove('open'); document.getElementById('modalBox').classList.remove('modal-wide'); }
document.getElementById('overlay').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLB(src) { document.getElementById('lbImg').src=src; document.getElementById('lightbox').classList.add('open'); }
document.getElementById('lbClose').onclick = () => document.getElementById('lightbox').classList.remove('open');
document.getElementById('lightbox').addEventListener('click', e => { if(e.target===e.currentTarget) document.getElementById('lightbox').classList.remove('open'); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg, isErr=false) {
  const el = document.getElementById('toast');
  el.className = isErr?'err':'';
  el.textContent = msg; el.style.display='block';
  clearTimeout(toastT);
  toastT = setTimeout(()=>{ el.style.display='none'; }, 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n) { return Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtDate(d) { return d ? new Date(d+'T12:00:00').toLocaleDateString('pt-BR') : 'â€”'; }
function fmtDT(d) { return d ? new Date(d).toLocaleDateString('pt-BR') : 'â€”'; }
</script>
</body>
</html>
